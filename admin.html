<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Painel Administrativo - Sistema GACIO</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    
    <!-- SheetJS para exportação Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* O estilo permanece exatamente como no arquivo original */
        :root {
            /* Paleta de cores laranja predominante */
            --primary-50: #fff3e0;
            --primary-100: #ffe0b2;
            --primary-200: #ffcc80;
            --primary-300: #ffb74d;
            --primary-400: #ffa726;
            --primary-500: #ff9800;
            --primary-600: #fb8c00;
            --primary-700: #f57c00;
            --primary-800: #ef6c00;
            --primary-900: #e65100;
            
            --secondary-500: #ff4081;
            
            --dark-bg: #1a1a2e;
            --dark-text: #ffffff;
            --dark-hover: #2d2d44;
            --dark-border: #2d2d44;
            
            --light-bg: #f8f9fa;
            --light-text: #212529;
            --light-hover: #e9ecef;
            
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
            --info: #2196f3;
            
            --neutral-50: #fafafa;
            --neutral-100: #f5f5f5;
            --neutral-200: #eeeeee;
            --neutral-300: #e0e0e0;
            --neutral-400: #bdbdbd;
            --neutral-500: #9e9e9e;
            --neutral-600: #757575;
            --neutral-700: #616161;
            --neutral-800: #424242;
            --neutral-900: #212121;
            
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--neutral-100);
            color: var(--neutral-800);
            line-height: 1.6;
            height: 100vh;
            overflow-x: hidden;
        }

        /* Utilitários */
        .d-none { display: none !important; }
        .d-flex { display: flex !important; }
        .flex-column { flex-direction: column; }
        .align-items-center { align-items: center; }
        .justify-content-center { justify-content: center; }
        .text-center { text-align: center; }
        .w-100 { width: 100%; }
        .h-100 { height: 100%; }
        .mb-3 { margin-bottom: 1rem; }
        .mt-3 { margin-top: 1rem; }
        .p-3 { padding: 1rem; }
        .gap-2 { gap: 0.5rem; }

        /* Tela de Login */
        .login-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-800), var(--primary-900));
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .login-card {
            background: white;
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 420px;
            position: relative;
            overflow: hidden;
        }

        .login-card::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 150px;
            height: 150px;
            background: var(--primary-500);
            border-radius: 50%;
            opacity: 0.1;
        }

        .login-card::after {
            content: '';
            position: absolute;
            bottom: -30px;
            left: -30px;
            width: 100px;
            height: 100px;
            background: var(--primary-500);
            border-radius: 50%;
            opacity: 0.1;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
        }

        .login-icon {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, var(--primary-700), var(--primary-900));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: white;
            font-size: 28px;
            box-shadow: 0 5px 15px rgba(245, 124, 0, 0.4);
        }

        .login-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--neutral-800);
            margin: 0 0 0.5rem 0;
            background: linear-gradient(to right, var(--primary-700), var(--primary-900));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-subtitle {
            color: var(--neutral-600);
            font-size: 1rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
            position: relative;
            z-index: 1;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: var(--neutral-700);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 0.85rem;
            border: 2px solid var(--neutral-300);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-600);
            box-shadow: 0 0 0 3px rgba(245, 124, 0, 0.2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.85rem 1.75rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .btn:hover::after {
            opacity: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-800));
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(245, 124, 0, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--neutral-600), var(--neutral-800));
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #2e7d32);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-sm {
            padding: 0.65rem 1.25rem;
            font-size: 0.875rem;
        }

        .alert {
            padding: 0.85rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Layout Principal */
        .main-app {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--dark-bg);
            color: var(--dark-text);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            transition: transform 0.3s ease;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 1.75rem;
            border-bottom: 1px solid var(--dark-border);
            text-align: center;
            background: linear-gradient(135deg, var(--primary-800), var(--primary-900));
        }

        .sidebar-icon {
            width: 56px;
            height: 56px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 22px;
        }

        .sidebar-title {
            font-size: 1.35rem;
            font-weight: 700;
            margin: 0;
            color: white;
        }

        .user-info {
            padding: 1.25rem 1.75rem;
            border-bottom: 1px solid var(--dark-border);
            background: rgba(0, 0, 0, 0.1);
        }

        .user-role {
            font-weight: 600;
            font-size: 0.95rem;
            color: white;
        }

        .user-code {
            font-size: 0.85rem;
            opacity: 0.8;
            color: rgba(255, 255, 255, 0.7);
        }

        .sidebar-menu {
            flex: 1;
            padding: 1.25rem 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 0.85rem;
            padding: 0.85rem 1.75rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.95rem;
            position: relative;
        }

        .menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: rgba(255, 255, 255, 0.1);
            transition: width 0.3s;
        }

        .menu-item:hover::before {
            width: 4px;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .menu-item.active::before {
            width: 4px;
            background: var(--primary-500);
        }

        .menu-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: auto;
            font-weight: 600;
        }

        /* Conteúdo Principal */
        .main-content {
            flex: 1;
            margin-left: 280px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .content-header {
            background: white;
            padding: 1.25rem 2rem;
            border-bottom: 1px solid var(--neutral-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .page-title {
            font-size: 1.65rem;
            font-weight: 700;
            color: var(--neutral-800);
            margin: 0;
            background: linear-gradient(to right, var(--primary-700), var(--primary-900));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .content-body {
            flex: 1;
            padding: 2rem;
            background: var(--neutral-50);
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
            gap: 1.75rem;
            margin-bottom: 2.5rem;
        }

        .kpi-card {
            background: white;
            border-radius: 16px;
            padding: 1.75rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--primary-500);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s;
        }

        .kpi-card:hover::before {
            transform: scaleX(1);
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .kpi-card.active {
            border-color: var(--primary-600);
            background: linear-gradient(to bottom right, var(--primary-50), white);
            box-shadow: 0 8px 20px rgba(245, 124, 0, 0.2);
        }

        .kpi-value {
            font-size: 2.75rem;
            font-weight: 800;
            color: var(--primary-700);
            margin: 0;
            font-family: 'Open Sans', sans-serif;
        }

        .kpi-label {
            font-size: 0.95rem;
            color: var(--neutral-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0.75rem 0 0 0;
            font-weight: 600;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
            gap: 1.75rem;
            margin-bottom: 2.5rem;
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 1.75rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--neutral-800);
            margin: 0 0 1.25rem 0;
        }

        .chart-container {
            position: relative;
            height: 320px;
        }

        /* Seção de Acionamentos */
        .section-header {
            margin-bottom: 2.5rem;
        }

        .section-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--neutral-800);
            margin: 0 0 0.75rem 0;
            background: linear-gradient(to right, var(--primary-700), var(--primary-900));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .section-subtitle {
            color: var(--neutral-600);
            margin: 0;
            font-size: 1.05rem;
        }

        .acionamentos-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .card-header {
            padding: 1.5rem 1.75rem;
            border-bottom: 1px solid var(--neutral-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            background: white;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--neutral-800);
            margin: 0;
        }

        .card-count {
            background: var(--primary-100);
            color: var(--primary-800);
            padding: 0.35rem 1rem;
            border-radius: 20px;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .card-body {
            padding: 0;
        }

        /* Barra de busca e filtros */
        .search-bar {
            padding: 1.25rem 1.75rem;
            border-bottom: 1px solid var(--neutral-200);
            background: white;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-container {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--neutral-500);
        }

        .search-input {
            width: 100%;
            padding: 0.85rem 1rem 0.85rem 45px;
            border: 2px solid var(--neutral-300);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-600);
            box-shadow: 0 0 0 3px rgba(245, 124, 0, 0.2);
        }

        .filter-container {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .filter-button {
            background: white;
            border: 2px solid var(--neutral-300);
            border-radius: 10px;
            padding: 0.75rem 1.25rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--neutral-700);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-button:hover {
            background: var(--neutral-100);
            border-color: var(--primary-500);
            color: var(--primary-700);
        }

        .filter-button.active {
            background: var(--primary-50);
            border-color: var(--primary-500);
            color: var(--primary-700);
        }

        /* Estados */
        .loading-state, .empty-state {
            padding: 3rem;
            text-align: center;
            color: var(--neutral-600);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--neutral-300);
            border-top: 4px solid var(--primary-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tabela */
        .table-container {
            overflow-x: auto;
            padding: 1.75rem;
        }

        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.95rem;
            border-radius: 12px;
            overflow: hidden;
        }

        .table th {
            background: var(--primary-600);
            color: white;
            font-weight: 600;
            padding: 1.25rem 1rem;
            text-align: left;
            white-space: nowrap;
            position: sticky;
            top: 0;
        }

        .table td {
            padding: 1.15rem 1rem;
            border-bottom: 1px solid var(--neutral-200);
            vertical-align: middle;
        }

        .table tbody tr {
            transition: background 0.2s;
        }

        .table tbody tr:hover {
            background: var(--primary-50);
        }

        .status-badge {
            padding: 0.4rem 0.9rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-block;
        }

        .status-pendente {
            background: #fff3cd;
            color: #856404;
        }

        .status-enviado {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-recurso_alocado {
            background: #d4edda;
            color: #155724;
        }

        .status-finalizado {
            background: #f8d7da;
            color: #721c24;
        }

        .status-cancelado {
            background: #eeeeee;
            color: #555555;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            padding: 1rem;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            display: flex;
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            position: relative;
            width: 100%;
            max-width: 850px;
            position: relative;
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 850px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            transform: translateY(20px);
            transition: transform 0.3s ease-out;
        }

        .modal.show .modal-content {
            position: relative;
            transform: translateY(0);
        }

        .modal-header {
            padding: 1.5rem 1.75rem;
            border-bottom: 1px solid var(--neutral-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, var(--primary-700), var(--primary-900));
            color: white;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            padding: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 1.75rem;
        }

        .modal-footer {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 1.5rem 1.75rem;
            border-top: 1px solid var(--neutral-200);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.75rem;
        }

        .form-group-full {
            grid-column: 1 / -1;
        }

        .form-control:disabled {
            background: var(--neutral-100);
            color: var(--neutral-600);
        }

        .editable-field {
            border-color: var(--success) !important;
        }

        .historico-section {
            margin-top: 1.75rem;
            padding-top: 1.75rem;
            border-top: 1px solid var(--neutral-200);
        }

        .historico-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--neutral-800);
            margin: 0 0 1.25rem 0;
        }

        .historico-container {
            max-height: 220px;
            overflow-y: auto;
            background: var(--neutral-50);
            border-radius: 10px;
            padding: 1.25rem;
            border: 1px solid var(--neutral-200);
        }

        /* Responsividade */
        @media (max-width: 992px) {
            .modal {
                align-items: center;
                justify-content: center;
                padding: 1rem;
            }
            .modal-content {
                width: 96vw;
                max-width: 96vw;
                margin: 0 auto;
                border-radius: 12px;
            }
            .modal {
            display: none;
                align-items: flex-start;
                padding-top: 0.75rem;
            }
            .modal-content {
            position: relative;
            width: 100%;
            max-width: 850px;
                width: 96vw;
                max-width: 96vw;
                margin: 0 auto;
                border-radius: 12px;
            }
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .content-header {
                padding: 1rem;
            }

            .content-body {
                padding: 1.25rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
            position: relative;
            width: 100%;
            max-width: 850px;
            position: relative;
                margin: 1rem;
                max-height: calc(100vh - 2rem);
            }

            .table-container {
                font-size: 0.85rem;
            }

            .table th,
            .table td {
                padding: 0.75rem 0.5rem;
            }

            .header-actions {
                width: 100%;
                justify-content: stretch;
            }

            .btn {
                flex: 1;
            }
        }

        /* Menu mobile */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--neutral-800);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            background: var(--neutral-100);
            border-radius: 8px;
        }

        @media (max-width: 992px) {
            .modal {
                align-items: center;
                justify-content: center;
                padding: 1rem;
            }
            .modal-content {
                width: 96vw;
                max-width: 96vw;
                margin: 0 auto;
                border-radius: 12px;
            }
            .modal {
            display: none;
                align-items: flex-start;
                padding-top: 0.75rem;
            }
            .modal-content {
            position: relative;
            width: 100%;
            max-width: 850px;
                width: 96vw;
                max-width: 96vw;
                margin: 0 auto;
                border-radius: 12px;
            }
            .mobile-menu-toggle {
                display: block;
            }
        }

        /* Overlay para mobile */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            backdrop-filter: blur(2px);
        }

        .sidebar-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        @media (min-width: 993px) {
            .sidebar-overlay {
                display: none;
            }
        }
    
/* === Overrides: modal centralizado e mais largo === */
.modal { 
    display: none; 
    position: fixed; 
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    align-items: center; 
    justify-content: center; 
    z-index: 2000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
    padding: 1rem;
    backdrop-filter: blur(5px);
}
.modal.show { 
    display: flex; 
    opacity: 1; 
    visibility: visible; 
    align-items: center; 
    justify-content: center; 
}
.modal-content { 
    width: 90vw; 
    max-width: 1100px; 
    margin: 0 auto; 
    border-radius: 16px;
}
@media (max-width: 992px) {
    .modal-content { width: 96vw; max-width: 96vw; }
}
/* === Fim overrides === */

</style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-header">
                <div class="login-icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <h1 class="login-title">Gestão de Acionamentos</h1>
                <p class="login-subtitle">Sistema de Acionamentos GACIO</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="username">
                        <i class="fas fa-user"></i> Usuário
                    </label>
                    <input type="text" id="username" class="form-control" placeholder="Digite seu usuário" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="password">
                        <i class="fas fa-lock"></i> Senha
                    </label>
                    <input type="password" id="password" class="form-control" placeholder="Digite sua senha" required>
                </div>
                
                <div id="loginError" class="alert alert-danger d-none">
                    Usuário ou senha incorretos.
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- Aplicação Principal -->
    <div id="mainApp" class="main-app d-none">
        <!-- Overlay para mobile -->
        <div id="sidebarOverlay" class="sidebar-overlay"></div>
        
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <h2 class="sidebar-title">Sistema GACIO</h2>
            </div>
            
            <div class="user-info">
                <div id="userRole" class="user-role">Desenvolvedor</div>
                <div id="userCode" class="user-code">CLB354374</div>
            </div>
            
            <nav class="sidebar-menu">
                <button class="menu-item active" data-section="dashboard">
                    <i class="fas fa-chart-pie"></i>
                    Dashboard
                </button>
                
                <button class="menu-item" data-section="acionamentos_pendentes">
                    <i class="fas fa-clock"></i>
                    Acionamentos Pendentes
                    <span id="pendentesCount" class="menu-badge">0</span>
                </button>
                
                <button class="menu-item" data-section="acionamentos_enviados">
                    <i class="fas fa-paper-plane"></i>
                    Acionamentos Enviados
                    <span id="enviadosCount" class="menu-badge">0</span>
                </button>
                
                <button class="menu-item" data-section="com_recurso_alocado">
                    <i class="fas fa-users"></i>
                    Com Recurso Alocado
                    <span id="recursoCount" class="menu-badge">0</span>
                </button>
                
                <button class="menu-item" data-section="ocorrencias_finalizadas">
                    <i class="fas fa-check-circle"></i>
                    Ocorrências Finalizadas
                    <span id="finalizadasCount" class="menu-badge">0</span>
                </button>
                
                <button class="menu-item" data-section="todas_ocorrencias">
                    <i class="fas fa-list"></i>
                    Todas as Ocorrências
                    <span id="todasCount" class="menu-badge">0</span>
                </button>
            </nav>
            
            <div style="margin-top: auto; padding: 1rem;">
                <button class="menu-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </button>
            </div>
        </div>
        
        <!-- Conteúdo Principal -->
        <div class="main-content">
            <div class="content-header">
                <div class="d-flex align-items-center gap-3">
                    <button class="mobile-menu-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 id="pageTitle" class="page-title">Dashboard</h1>
                </div>
                
                <div class="header-actions">
                    <button class="btn btn-success btn-sm" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Exportar Excel
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="loadAcionamentos()">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                </div>
            </div>
            
            <div class="content-body">
                <!-- Dashboard -->
                <div id="dashboardSection">
                    <div class="section-header">
                        <h2 class="section-title">Dashboard</h2>
                        <p class="section-subtitle">Visão geral dos acionamentos e métricas do sistema</p>
                    </div>
                    
                    <!-- KPIs -->
                    <div class="dashboard-grid">
                        <div class="kpi-card" data-status="PENDENTE" onclick="filterByStatus('PENDENTE')">
                            <h3 id="kpiPendentes" class="kpi-value">0</h3>
                            <p class="kpi-label">Pendentes</p>
                        </div>
                        
                        <div class="kpi-card" data-status="ENVIADO" onclick="filterByStatus('ENVIADO')">
                            <h3 id="kpiEnviados" class="kpi-value">0</h3>
                            <p class="kpi-label">Enviados</p>
                        </div>
                        
                        <div class="kpi-card" data-status="RECURSO_ALOCADO" onclick="filterByStatus('RECURSO_ALOCADO')">
                            <h3 id="kpiRecurso" class="kpi-value">0</h3>
                            <p class="kpi-label">Com Recurso</p>
                        </div>
                        
                        <div class="kpi-card" data-status="FINALIZADO" onclick="filterByStatus('FINALIZADO')">
                            <h3 id="kpiFinalizados" class="kpi-value">0</h3>
                            <!-- Contabiliza finalizados e cancelados juntos -->
                            <p class="kpi-label">Finalizados / Cancelados</p>
                        </div>
                        
                        <div class="kpi-card" data-status="TODOS" onclick="filterByStatus('TODOS')">
                            <h3 id="kpiTodos" class="kpi-value">0</h3>
                            <p class="kpi-label">Todos os Status</p>
                        </div>
                    </div>
                    
                    <!-- Gráficos -->
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3 class="chart-title">Tempo Médio Entre Status</h3>
                            <div class="chart-container">
                                <canvas id="tempoStatusChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <h3 class="chart-title">Distribuição por Tipo de Equipe</h3>
                            <div class="chart-container">
                                <canvas id="tipoEquipeChart"></canvas>
                            </div>
                        </div>

                        <!-- Novo gráfico: Distribuição por Tipo de Defeito -->
                        <div class="chart-card">
                            <h3 class="chart-title">Distribuição por Tipo de Defeito</h3>
                            <div class="chart-container">
                                <canvas id="tipoDefeitoChart"></canvas>
                            </div>
                        </div>

                        <!-- Novo gráfico: Top 5 Acionamentos com mais Clientes Interrompidos -->
                        <div class="chart-card">
                            <h3 class="chart-title">Top 5 Acionamentos - Clientes Interrompidos</h3>
                            <div class="chart-container">
                                <canvas id="topClientesChart"></canvas>
                            </div>
                        </div>

                        <!-- Novo gráfico: Top 10 Alimentadores com mais Acionamentos -->
                        <div class="chart-card">
                            <h3 class="chart-title">Top 10 Alimentadores - Acionamentos</h3>
                            <div class="chart-container">
                                <canvas id="topAlimentadoresChart"></canvas>
                            </div>
                        </div>

                        <!-- Novo gráfico: Top 5 ocorrências com maior tempo desde a criação -->
                        <div class="chart-card">
                            <h3 class="chart-title">Top 5 Tempo desde Criação (horas)</h3>
                            <div class="chart-container">
                                <canvas id="topTempoChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Seção de Acionamentos -->
                <div id="acionamentosSection" class="d-none">
                    <div class="section-header">
                        <h2 id="sectionTitle" class="section-title">Acionamentos</h2>
                        <p id="sectionSubtitle" class="section-subtitle">Gerencie os acionamentos</p>
                    </div>
                    
                    <div class="acionamentos-card">
                        <div class="card-header">
                            <h3 id="cardTitle" class="card-title">Acionamentos</h3>
                            <span id="cardCount" class="card-count">0 acionamentos</span>
                        </div>
                        
                        <!-- Barra de busca e filtros -->
                        <div class="search-bar">
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchInput" class="search-input" placeholder="Buscar em todos os campos..." oninput="filterTable()">
                            </div>
                            
                            <div class="filter-container">
                                <button class="filter-button active" data-filter="all" onclick="filterTable('all')">
                                    <i class="fas fa-filter"></i> Todos
                                </button>
                                <button class="filter-button" data-filter="pendente" onclick="filterTable('pendente')">
                                    <i class="fas fa-clock"></i> Pendentes
                                </button>
                                <button class="filter-button" data-filter="enviado" onclick="filterTable('enviado')">
                                    <i class="fas fa-paper-plane"></i> Enviados
                                </button>
                                <button class="filter-button" data-filter="recurso" onclick="filterTable('recurso')">
                                    <i class="fas fa-users"></i> Com Recurso
                                </button>
                                <button class="filter-button" data-filter="finalizado" onclick="filterTable('finalizado')">
                                    <i class="fas fa-check-circle"></i> Finalizados
                                </button>
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <!-- Estado de Carregamento -->
                            <div id="loadingState" class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Carregando acionamentos...</p>
                            </div>
                            
                            <!-- Estado Vazio -->
                            <div id="emptyState" class="empty-state d-none">
                                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <h4>Nenhum acionamento encontrado</h4>
                                <p>Não há acionamentos nesta categoria no momento.</p>
                            </div>
                            
                            <!-- Tabela -->
                            <div id="tableContainer" class="table-container d-none">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Número</th>
                                            <th>Equipe</th>
                                            <th>Tipo Defeito</th>
                                            <th>Alimentador</th>
                                            <th>Referência</th>
                                            <th>Clientes Interrompidos</th>
                                            <th>Tempo desde Criação</th>
                                            <th>Tempo desde Acionamento</th>
                                            <th>Status</th>
                                            <th>Data Criação</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="acionamentosTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edição -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Editar Acionamento</h3>
                <button class="modal-close" onclick="closeEditModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editId">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="editNumero">Número da Ocorrência</label>
                            <input type="text" id="editNumero" class="form-control" disabled>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="editDataCriacao">Data de Criação</label>
                            <input type="date" id="editDataCriacao" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="editHorarioCriacao">Horário de Criação</label>
                            <input type="time" id="editHorarioCriacao" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="editEquipe">Equipe</label>
                            <select id="editEquipe" class="form-control">
                                <option value="">Selecione a equipe</option>
                                <option value="EQUIPE_01">EQUIPE 01</option>
                                <option value="EQUIPE_02">EQUIPE 02</option>
                                <option value="EQUIPE_03">EQUIPE 03</option>
                                <option value="EQUIPE_04">EQUIPE 04</option>
                                <option value="EQUIPE_05">EQUIPE 05</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="editTipoEquipe">Tipo de Equipe</label>
                            <select id="editTipoEquipe" class="form-control">
                                <option value="">Selecione o tipo</option>
                                <option value="PESADA">PESADA</option>
                                <option value="PODA">PODA</option>
                                <option value="LINHA_VIVA">LINHA VIVA</option>
                                <option value="LEVE">LEVE</option>
                                <option value="PESADA_PODA">PESADA+PODA</option>
                                <option value="PESADA_LINHA_VIVA">PESADA+LINHA VIVA</option>
                                <option value="LINHA_VIVA_PODA">LINHA VIVA+PODA</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="editTipoDefeito">Tipo de Defeito</label>
                            <select id="editTipoDefeito" class="form-control">
                                <option value="">Selecione o defeito</option>
                                <option value="POSTE">POSTE</option>
                                <option value="TRAFO">TRAFO</option>
                                <option value="VAO_REDE">VÃO DE REDE</option>
                                <option value="PODA">PODA</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="editAlimentador">Alimentador</label>
                            <input type="text" id="editAlimentador" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="editTipoReferencia">Tipo de Referência</label>
                            <select id="editTipoReferencia" class="form-control">
                                <option value="">Tipo</option>
                                <option value="PG">PG</option>
                                <option value="TRAFO">TRAFO</option>
                                <option value="MEDIDOR">MEDIDOR</option>
                                <option value="CC">CC</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="editNumeroReferencia">Número da Referência</label>
                            <input type="text" id="editNumeroReferencia" class="form-control">
                        </div>
                        
                        <div id="clientesInterrompidosGroup" class="form-group">
                            <label class="form-label" for="editClientesInterrompidos">Clientes Interrompidos</label>
                            <input type="text" id="editClientesInterrompidos" class="form-control" placeholder="Digite um número ou 'calculando'">
                        </div>
                        
                        <div class="form-group form-group-full">
                            <label class="form-label" for="editRelatorio">Relatório da Ocorrência</label>
                            <textarea id="editRelatorio" class="form-control" rows="4"></textarea>
                        </div>
                        
                        <div class="form-group form-group-full">
                            <label class="form-label" for="editMateriais">Materiais Necessários</label>
                            <textarea id="editMateriais" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <!-- Histórico -->
                    <div class="historico-section">
                        <h4 class="historico-title">Histórico de Alterações</h4>
                        <div id="historicoContainer" class="historico-container">
                            <p>Nenhum histórico disponível.</p>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancelar</button>
                <button type="button" id="salvarBtn" class="btn btn-primary" onclick="salvarEdicao()">Salvar</button>
                <button type="button" id="validarBtn" class="btn btn-success" onclick="validarAcionamento()">Validar</button>
                <button type="button" id="alocarBtn" class="btn btn-primary" onclick="alocarRecurso()">Alocar Recurso</button>
                <button type="button" id="finalizarBtn" class="btn btn-success" onclick="finalizarAcionamento()">Finalizar</button>
                <button type="button" id="retroagirBtn" class="btn btn-secondary" onclick="retroagirStatus()">Retroagir Status</button>
                <button type="button" id="cancelarBtn" class="btn btn-secondary" onclick="cancelarAcionamento()">Cancelar acionamento</button>
            </div>
    </div>

    <script>
        // Fechar ao clicar fora do conteúdo
        (function() {
            const modal = document.getElementById('editModal');
            if (modal) {
                modal.addEventListener('click', function(e){
                    if (e.target === modal) closeEditModal();
                });
            }
        })();

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCv7vfGMSobE1n0M1CECl46LdMy3pdrxh4",
            authDomain: "pedido-de-material---ilheus.firebaseapp.com",
            projectId: "pedido-de-material---ilheus",
            storageBucket: "pedido-de-material---ilheus.appspot.com",
            messagingSenderId: "155845988594",
            appId: "1:155845988594:web:322f34f9790f605a92006b"
        };

        // Inicializar Firebase
        let db = null;
        let auth = null;
        let firebaseInitialized = false;

        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                auth = firebase.auth();
                // Persistência local para manter login após reload
                auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(console.error);
                firebaseInitialized = true;
                console.log('Firebase inicializado com sucesso no admin');
            } catch (error) {
                console.error('Erro ao inicializar Firebase no admin:', error);
                firebaseInitialized = false;
            }
        }

        // Variáveis globais
        let currentUser = null;
        let acionamentos = [];
        let currentStatus = 'DASHBOARD';
        let sessionTimeout = null;
        let currentFilter = 'TODOS';
        let charts = {};
// Paleta de cores para gráficos dinâmicos
const colorPalette = [
    '#1F497D', '#2E86AB', '#4FB0C6', '#7BBF6A', '#F6C85F',
    '#E07A5F', '#3D405B', '#6C757D', '#A3A3A3', '#D9E2EC'
];

        // Função auxiliar para obter data e hora local respeitando o fuso horário do usuário (America/Bahia)
        // Retorna um objeto com a data (yyyy-mm-dd) e a hora (HH:MM) no horário local.
        function getLocalDateParts() {
            const now = new Date();
            // Use toLocaleDateString com o locale 'en-CA' que gera yyyy-mm-dd por padrão
            // e defina explicitamente o fuso horário de Bahia para evitar deslocamentos inesperados.
            const datePart = now.toLocaleDateString('en-CA', { timeZone: 'America/Bahia' });
            // Use toLocaleTimeString com hora de 24 horas para obter HH:MM no fuso de Bahia
            const timePart = now.toLocaleTimeString('pt-BR', {
                timeZone: 'America/Bahia',
                hour12: false,
                hour: '2-digit',
                minute: '2-digit'
            });
            return { date: datePart, time: timePart };
        }
        let currentTableData = []; // Para armazenar os dados atuais da tabela

        const SESSION_DURATION = 30 * 60 * 1000; // 30 minutos

        // Inicializar aplicação
        document.addEventListener('DOMContentLoaded', () => {
            try { document.getElementById('editModal').classList.remove('show'); } catch(e){}
            // Registrar plugin datalabels
            Chart.register(ChartDataLabels);
            
            initializeFirebase();
            // Restaurar sessão imediatamente se válida
            if (checkSession()) {
                if (currentUser.role === 'admin2') { showSection('acionamentos_enviados'); } else { showSection('dashboard'); }
                loadAcionamentos();
            }
            
            
        // Keep-alive da sessão em qualquer interação
        document.addEventListener('click', resetSessionTimeout, true);
        document.addEventListener('keydown', resetSessionTimeout, true);

            // Configurar formulário de login
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Verificar se usuário já está logado
            auth.onAuthStateChanged(user => {
                if (user) {
                    const email = user.email;
                    const username = email.split('@')[0];
                    determineUserRole(username);
                } else {
                    // Só mostra login se não houver sessão válida no localStorage
                    if (!checkSession()) {
                        document.getElementById('loginScreen').classList.remove('d-none');
                        document.getElementById('mainApp').classList.add('d-none');
                    }
                }
            });
            
            // Configurar menu
            document.querySelectorAll('.menu-item[data-section]').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.getAttribute('data-section');
                    showSection(section);
                });
            });
            
            // Configurar overlay do sidebar
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
        });

        // Função de login
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('username').value + '@gacio.com';
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            try {
                // Fazer login com Firebase Auth
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Extrair a matrícula do email (parte antes de '@')
                const username = email.split('@')[0];
                
                // Buscar dados do usuário no Firestore
                await determineUserRole(username);
                
            } catch (error) {
                console.error('Erro no login:', error);
                errorDiv.textContent = 'Usuário ou senha incorretos.';
                errorDiv.classList.remove('d-none');
            }
        }

        // Função para determinar o papel do usuário
        async function determineUserRole(username) {
            let userCollection = '';
            
            if (username.startsWith('CLB')) {
                userCollection = 'usuarioclb';
            } else if (username.startsWith('EPS')) {
                userCollection = 'usuarioeps';
            } else {
                throw new Error('Domínio de email não suportado');
            }
            
            try {
                // Buscar o usuário na coleção correspondente
                const userDoc = await db.collection(userCollection).doc(username).get();
                
                if (!userDoc.exists) {
                    throw new Error('Usuário não encontrado na base');
                }
                
                const userData = userDoc.data();
                currentUser = {
                    username: username,
                    name: userData.nome,
                    role: username.startsWith('CLB') ? 'admin1' : 'admin2'
                };
                
                // Salvar sessão
                const sessionData = {
                    user: currentUser,
                    timestamp: Date.now()
                };
                localStorage.setItem('clb_session', JSON.stringify(sessionData));
                
                // Atualizar interface
                document.getElementById('userRole').textContent = currentUser.name;
                document.getElementById('userCode').textContent = currentUser.username;
                
                // Configurar permissões do menu
                setupMenuPermissions();
                
                // Mostrar aplicação
                document.getElementById('loginScreen').classList.add('d-none');
                document.getElementById('mainApp').classList.remove('d-none');
                
                // Configurar timeout de sessão
                resetSessionTimeout();
                
                // Redirecionar ADMIN2 para acionamentos enviados
                if (currentUser.role === 'admin2') {
                    showSection('acionamentos_enviados');
                } else {
                    showSection('dashboard');
                }
                
                // Carregar acionamentos
                loadAcionamentos();
                
            } catch (error) {
                console.error('Erro ao obter dados do usuário:', error);
                auth.signOut();
                document.getElementById('loginError').textContent = 'Erro ao carregar dados do usuário.';
                document.getElementById('loginError').classList.remove('d-none');
            }
        }

        // Função para configurar permissões do menu
        function setupMenuPermissions() {
            const menuItems = document.querySelectorAll('.menu-item');
            
            menuItems.forEach(item => {
                const section = item.getAttribute('data-section');
                
                if (currentUser.role === 'admin2') {
                    // ADMIN2 não pode acessar acionamentos pendentes e todas as ocorrências
                    if (section === 'acionamentos_pendentes' || section === 'todas_ocorrencias') {
                        item.style.display = 'none';
                    }
                }
            });
        }

        // Função para verificar sessão
        function checkSession() {
            const sessionData = localStorage.getItem('clb_session');
            
            if (sessionData) {
                const session = JSON.parse(sessionData);
                const now = Date.now();
                
                // Verificar se a sessão não expirou
                if (now - session.timestamp < SESSION_DURATION) {
                    currentUser = session.user;
                    
                    // Atualizar interface
                    document.getElementById('userRole').textContent = currentUser.name;
                    document.getElementById('userCode').textContent = currentUser.username;
                    
                    // Configurar permissões do menu
                    setupMenuPermissions();
                    
                    // Mostrar aplicação
                    document.getElementById('loginScreen').classList.add('d-none');
                    document.getElementById('mainApp').classList.remove('d-none');
                    
                    // Configurar timeout de sessão
                    resetSessionTimeout();
                    
                    return true;
                }
            }
            
            // Limpar sessão expirada
            localStorage.removeItem('clb_session');
            return false;
        }

        // Função para resetar timeout de sessão
        function resetSessionTimeout() {
            // Atualiza timestamp no localStorage a cada interação para manter a sessão viva
            try {
                const sessionData = localStorage.getItem('clb_session');
                if (sessionData) {
                    const s = JSON.parse(sessionData);
                    s.timestamp = Date.now();
                    localStorage.setItem('clb_session', JSON.stringify(s));
                }
            } catch (e) {}
            if (sessionTimeout) {
                clearTimeout(sessionTimeout);
            }
            
            sessionTimeout = setTimeout(() => {
                logout();
                alert('Sua sessão expirou. Faça login novamente.');
            }, SESSION_DURATION);
        }

        // Função de logout
        function logout() {
            auth.signOut().then(() => {
                currentUser = null;
                localStorage.removeItem('clb_session');
                
                if (sessionTimeout) {
                    clearTimeout(sessionTimeout);
                }
                
                document.getElementById('loginScreen').classList.remove('d-none');
                document.getElementById('mainApp').classList.add('d-none');
                
                // Limpar formulário
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('loginError').classList.add('d-none');
            });
        }

        // Função para mostrar seção
        function showSection(section) {
            closeEditModal();
            // Resetar timeout de sessão em qualquer atividade
            resetSessionTimeout();
            
            // Verificar permissões
            if (currentUser.role === 'admin2') {
                if (section === 'acionamentos_pendentes' || section === 'todas_ocorrencias') {
                    return; // Silenciosamente não fazer nada
                }
            }
            
            currentStatus = section.toUpperCase();
            
            // Atualizar menu ativo
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`[data-section="${section}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
            
            // Mostrar/ocultar seções
            if (section === 'dashboard') {
                document.getElementById('dashboardSection').classList.remove('d-none');
                document.getElementById('acionamentosSection').classList.add('d-none');
                document.getElementById('pageTitle').textContent = 'Dashboard';
                // Carregar métricas do dashboard
                loadDashboard();
                // Criar gráficos (inclui gráficos adicionais) com os dados atuais
                createCharts();
                // Atualizar gráficos com filtros atuais
                updateCharts();
            } else {
                document.getElementById('dashboardSection').classList.add('d-none');
                document.getElementById('acionamentosSection').classList.remove('d-none');
                
                // Atualizar títulos
                const titles = {
                    'acionamentos_pendentes': { title: 'Acionamentos Pendentes', subtitle: 'Gerencie os acionamentos que aguardam validação' },
                    'acionamentos_enviados': { title: 'Acionamentos Enviados', subtitle: 'Acionamentos enviados para a EPS' },
                    'com_recurso_alocado': { title: 'Com Recurso Alocado', subtitle: 'Acionamentos com equipe alocada' },
                    'ocorrencias_finalizadas': { title: 'Ocorrências Finalizadas', subtitle: 'Acionamentos finalizados' },
                    'todas_ocorrencias': { title: 'Todas as Ocorrências', subtitle: 'Visualização completa de todos os acionamentos' }
                };
                
                const sectionInfo = titles[section];
                if (sectionInfo) {
                    document.getElementById('pageTitle').textContent = sectionInfo.title;
                    document.getElementById('sectionTitle').textContent = sectionInfo.title;
                    document.getElementById('sectionSubtitle').textContent = sectionInfo.subtitle;
                    document.getElementById('cardTitle').textContent = sectionInfo.title;
                }
                
                loadAcionamentos();
            }
        }

        // Função para carregar acionamentos
        async function loadAcionamentos() {
            // garantir modal fechado antes de recarregar tabela
            closeEditModal();
            if (!firebaseInitialized) {
                console.log('Firebase não inicializado');
                return;
            }
            
            try {
                document.getElementById('loadingState').classList.remove('d-none');
                document.getElementById('emptyState').classList.add('d-none');
                document.getElementById('tableContainer').classList.add('d-none');
                
                const snapshot = await db.collection('acionamentos').get();
                acionamentos = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    acionamentos.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                // Filtrar por status
                let filteredAcionamentos = acionamentos;
                if (currentStatus !== 'TODAS_OCORRENCIAS') {
                    const statusMap = {
                        'ACIONAMENTOS_PENDENTES': 'PENDENTE',
                        'ACIONAMENTOS_ENVIADOS': 'ENVIADO',
                        'COM_RECURSO_ALOCADO': 'RECURSO_ALOCADO',
                        'OCORRENCIAS_FINALIZADAS': 'FINALIZADO'
                    };
                    if (currentStatus === 'OCORRENCIAS_FINALIZADAS') {
                        // Incluir cancelados junto com finalizados
                        filteredAcionamentos = acionamentos.filter(a => a.status === 'FINALIZADO' || a.status === 'CANCELADO');
                    } else {
                        filteredAcionamentos = acionamentos.filter(a => a.status === statusMap[currentStatus]);
                    }
                } else {
                    // Para ADMIN2, filtrar acionamentos pendentes e cancelados em "todas as ocorrências"
                    if (currentUser.role === 'admin2') {
                        filteredAcionamentos = acionamentos.filter(a => a.status !== 'PENDENTE' && a.status !== 'CANCELADO');
                    }
                }
                
                document.getElementById('loadingState').classList.add('d-none');
                
                if (filteredAcionamentos.length === 0) {
                    document.getElementById('emptyState').classList.remove('d-none');
                } else {
                    document.getElementById('tableContainer').classList.remove('d-none');
                    renderAcionamentosTable(filteredAcionamentos);
                }
                
                // Atualizar contador
                document.getElementById('cardCount').textContent = `${filteredAcionamentos.length} acionamentos`;
                
                // Atualizar contadores do menu
                updateCounters();
                
            } catch (error) {
                console.error('Erro ao carregar acionamentos:', error);
                document.getElementById('loadingState').classList.add('d-none');
                document.getElementById('emptyState').classList.remove('d-none');
            }
        }

        // Função para renderizar tabela de acionamentos
        function renderAcionamentosTable(data) {
            const tbody = document.getElementById('acionamentosTableBody');
            if (!tbody) {
                console.error('Elemento acionamentosTableBody não encontrado');
                return;
            }
            
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem;">Nenhum acionamento encontrado</td></tr>';
                return;
            }
            
            // Salvar dados atuais para filtragem
            currentTableData = data;
            
            data.forEach(acionamento => {
                const row = document.createElement('tr');
                
                // Calcular tempos (congelar apenas quando status for Cancelado ou Finalizado)
                const tempoDesdeCreacao = calcularTempoDecorrido(
                    acionamento.data_criacao_ocorrencia, 
                    acionamento.horario_criacao_ocorrencia,
                    acionamento
                );
                const tempoDesdeAcionamento = calcularTempoDecorrido(
                    acionamento.data_criacao, 
                    null,
                    acionamento
                );
                
                // Criar células individualmente para garantir que o botão seja renderizado
                const cells = [
                    acionamento.numero_ocorrencia || acionamento.id,
                    acionamento.equipe || '-',
                    acionamento.tipo_defeito || '-',
                    acionamento.alimentador || '-',
                    `${acionamento.tipo_referencia || ''} ${acionamento.numero_referencia || ''}`.trim(),
                    acionamento.clientes_interrompidos || '-',
                    tempoDesdeCreacao,
                    tempoDesdeAcionamento,
                    `<span class="status-badge status-${acionamento.status?.toLowerCase() || 'pendente'}">${getStatusLabel(acionamento.status)}</span>`,
                    formatarData(acionamento.data_criacao_ocorrencia)
                ];
                
                // Adicionar células de dados
                cells.forEach((cellContent, index) => {
                    const td = document.createElement('td');
                    if (index === 5 || index === 6) { // Colunas de tempo
                        td.className = 'time-column';
                    }
                    td.innerHTML = cellContent;
                    row.appendChild(td);
                });
                
                // Adicionar célula de ações
                const actionTd = document.createElement('td');
                const editButton = document.createElement('button');
                editButton.className = 'btn btn-primary btn-sm';
                editButton.innerHTML = '<i class="fas fa-edit"></i>';
                editButton.onclick = function() {
                    editAcionamento(acionamento.id);
                };
                actionTd.appendChild(editButton);
                row.appendChild(actionTd);
                
                tbody.appendChild(row);
            });
            
            console.log(`Tabela renderizada com ${data.length} acionamentos`);
        }

        
// Helper: parse date + time as local Date object (robust against different formats)
function parseDateTimeLocal(dateStr, timeStr) {
    if (!dateStr) return null;
    // Normalize date expected as YYYY-MM-DD
    const dateParts = String(dateStr).split('-');
    let year, month, day;
    if (dateParts.length === 3) {
        year = parseInt(dateParts[0], 10);
        month = parseInt(dateParts[1], 10) - 1;
        day = parseInt(dateParts[2], 10);
    } else {
        // fallback to Date parser
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return null;
        return d;
    }

    // Normalize time HH:MM or HH:MM:SS
    let hh = 0, mm = 0, ss = 0;
    if (timeStr) {
        const t = String(timeStr).split(':');
        hh = parseInt(t[0] || 0, 10);
        mm = parseInt(t[1] || 0, 10);
        ss = parseInt(t[2] || 0, 10);
    }

    return new Date(year, month, day, hh, mm, ss);
}

// Função para calcular tempo decorrido (congela quando status é CANCELADO ou FINALIZADO)
// Agora usa parseDateTimeLocal e evita tempos negativos (ignora diffs negativos e retorna '0m' em vez de valores negativos)
function calcularTempoDecorrido(dataInicio, horaInicio = null, acionamento) {
    if (!dataInicio) return '-';

    const inicio = parseDateTimeLocal(dataInicio, horaInicio);
    if (!inicio || isNaN(inicio.getTime())) return '-';

    let fim = null;

    // Congelar tempo quando status for CANCELADO ou FINALIZADO
    if (acionamento.status === 'CANCELADO' && acionamento.data_cancelamento) {
        fim = parseDateTimeLocal(acionamento.data_cancelamento, acionamento.hora_cancelamento || null) || new Date(acionamento.data_cancelamento);
    } else if (acionamento.status === 'FINALIZADO' && acionamento.data_finalizacao) {
        fim = parseDateTimeLocal(acionamento.data_finalizacao, acionamento.hora_finalizacao || null) || new Date(acionamento.data_finalizacao);
    } else {
        fim = new Date(); // Usa a data/hora atual
    }

    if (!fim || isNaN(fim.getTime())) return '-';

    const diffMs = fim - inicio;

    // Evitar valores negativos — pode ocorrer por dados inconsistentes; nesses casos retornamos '0m' ao invés de negativo.
    if (diffMs <= 0) {
        return '0m';
    }

    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

    if (diffHours > 0) {
        return `${diffHours}h ${diffMinutes}m`;
    } else {
        return `${diffMinutes}m`;
    }
}


function filterTable(filterType) {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#acionamentosTableBody tr');
            const filterButtons = document.querySelectorAll('.filter-button');
            
            // Atualizar botões de filtro ativos
            filterButtons.forEach(button => {
                if (button.dataset.filter === filterType) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            // Aplicar filtro
            rows.forEach(row => {
                let showRow = true;
                
                // Aplicar filtro por tipo
                if (filterType && filterType !== 'all') {
                    const statusCell = row.querySelector('td:nth-child(9)');
                    if (statusCell) {
                        const statusText = statusCell.textContent.toLowerCase();
                        // Incluir cancelados no filtro de finalizados
                        if (filterType === 'finalizado') {
                            if (!(statusText.includes('finalizado') || statusText.includes('cancelado'))) {
                                showRow = false;
                            }
                        } else {
                            if (!statusText.includes(filterType)) {
                                showRow = false;
                            }
                        }
                    }
                }
                
                // Aplicar filtro por texto
                if (showRow && searchText) {
                    let found = false;
                    const cells = row.querySelectorAll('td');
                    
                    for (let i = 0; i < cells.length - 1; i++) { // Ignorar a coluna de ações
                        const cellText = cells[i].textContent || cells[i].innerText;
                        if (cellText.toLowerCase().includes(searchText)) {
                            found = true;
                            break;
                        }
                    }
                    
                    showRow = found;
                }
                
                if (showRow) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Função para formatar data
        function formatarData(data) {
            if (!data) return '-';
            if (data.includes('T')) {
                return new Date(data).toLocaleDateString('pt-BR');
            }
            return new Date(data + 'T00:00:00').toLocaleDateString('pt-BR');
        }

        // Função para obter label do status
        function getStatusLabel(status) {
            const labels = {
                'PENDENTE': 'Pendente',
                'ENVIADO': 'Enviado',
                'RECURSO_ALOCADO': 'Com Recurso',
                'FINALIZADO': 'Finalizado',
                'CANCELADO': 'Cancelado'
            };
            return labels[status] || 'Pendente';
        }

        // Função para atualizar contadores
        function updateCounters() {
            const pendentes = acionamentos.filter(a => a.status === 'PENDENTE').length;
            const enviados = acionamentos.filter(a => a.status === 'ENVIADO').length;
            const recurso = acionamentos.filter(a => a.status === 'RECURSO_ALOCADO').length;
            // Contabilizar finalizados e cancelados juntos
            const finalizadas = acionamentos.filter(a => a.status === 'FINALIZADO' || a.status === 'CANCELADO').length;
            
            document.getElementById('pendentesCount').textContent = pendentes;
            document.getElementById('enviadosCount').textContent = enviados;
            document.getElementById('recursoCount').textContent = recurso;
            document.getElementById('finalizadasCount').textContent = finalizadas;
            document.getElementById('todasCount').textContent = acionamentos.length;
        }

        // Função para editar acionamento
        function editAcionamento(id) {
            const acionamento = acionamentos.find(a => a.id === id);
            if (!acionamento) return;
            
            // Preencher formulário
            document.getElementById('editId').value = id;
            document.getElementById('editNumero').value = acionamento.numero_ocorrencia || acionamento.id;
            document.getElementById('editDataCriacao').value = acionamento.data_criacao_ocorrencia || '';
            document.getElementById('editHorarioCriacao').value = acionamento.horario_criacao_ocorrencia || '';
            document.getElementById('editEquipe').value = acionamento.equipe || '';
            document.getElementById('editTipoEquipe').value = acionamento.tipo_equipe || '';
            document.getElementById("editTipoDefeito").value = acionamento.tipo_defeito || '';
            document.getElementById("editAlimentador").value = acionamento.alimentador || '';
            document.getElementById('editTipoReferencia').value = acionamento.tipo_referencia || '';
            document.getElementById('editNumeroReferencia').value = acionamento.numero_referencia || '';
            document.getElementById('editClientesInterrompidos').value = acionamento.clientes_interrompidos || '';
            document.getElementById('editRelatorio').value = acionamento.relatorio_ocorrencia || '';
            document.getElementById('editMateriais').value = acionamento.materiais_necessarios || '';

            // Exibir histórico
            const historicoContainer = document.getElementById('historicoContainer');
            historicoContainer.innerHTML = '';
            if (acionamento.historico && acionamento.historico.length > 0) {
                acionamento.historico.forEach(entry => {
                    const p = document.createElement('p');
                    // Determinar data e hora considerando diferentes formatos
                    let displayDate = '';
                    if (entry.dataHora) {
                        const dt = new Date(entry.dataHora);
                        const datePart = dt.toLocaleDateString('pt-BR');
                        const timePart = dt.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        displayDate = `${datePart} ${timePart}`;
                    } else if (entry.data && entry.hora) {
                        displayDate = `${entry.data} ${entry.hora}`;
                    } else if (entry.data) {
                        // Parse YYYY-MM-DD sem deslocamento de fuso
                        const parts = entry.data.split('-');
                        if (parts.length === 3) {
                            displayDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
                        } else {
                            displayDate = entry.data;
                        }
                        if (entry.hora) {
                            displayDate += ` ${entry.hora}`;
                        }
                    }
                    p.innerHTML = `<strong>${displayDate}</strong> - ${entry.usuario}: ${entry.acao}`;
                    // Adicionar detalhes das mudanças se houver
                    let detailsHtml = '';
                    if (entry.detalhes) {
                        if (entry.detalhes.campos_alterados && entry.detalhes.campos_alterados.length > 0) {
                            detailsHtml += '<ul>';
                            entry.detalhes.campos_alterados.forEach(change => {
                                const label = change.label || change.campo;
                                const before = (change.valor_anterior !== undefined ? change.valor_anterior : (change.de !== undefined ? change.de : ''));
                                const after = (change.valor_novo !== undefined ? change.valor_novo : (change.para !== undefined ? change.para : ''));
                                detailsHtml += `<li>${label}: <em>${before || '-'}</em> → <strong>${after || '-'}</strong></li>`;
                            });
                            detailsHtml += '</ul>';
                        } else if (entry.detalhes.status_anterior !== undefined || entry.detalhes.status_novo !== undefined) {
                            const before = entry.detalhes.status_anterior || '-';
                            const after = entry.detalhes.status_novo || '-';
                            detailsHtml += `<p>Status: <em>${before}</em> → <strong>${after}</strong></p>`;
                        }
                    } else if (entry.changes && Array.isArray(entry.changes)) {
                        // Suporte para formato antigo
                        detailsHtml += '<ul>';
                        entry.changes.forEach(change => {
                            const label = change.label || change.campo;
                            detailsHtml += `<li>${label}: <em>${change.de}</em> → <strong>${change.para}</strong></li>`;
                        });
                        detailsHtml += '</ul>';
                    }
                    if (detailsHtml) {
                        p.innerHTML += detailsHtml;
                    }
                    p.style.marginBottom = '0.75rem';
                    p.style.fontSize = '0.875rem';
                    historicoContainer.appendChild(p);
                });
            } else {
                historicoContainer.innerHTML = '<p>Nenhum histórico disponível.</p>';
            }
            
            // Configurar permissões de edição
            const isAdmin1 = currentUser.role === 'admin1';
            const status = acionamento.status || 'PENDENTE';
            const isFinalizado = status === 'FINALIZADO';
            
            // Campos editáveis baseado no status e permissões
            const campos = ['editDataCriacao', 'editHorarioCriacao', 'editEquipe', 'editTipoEquipe', 'editTipoDefeito', 'editAlimentador', 'editTipoReferencia', 'editNumeroReferencia', 'editMateriais'];
            
            campos.forEach(campo => {
                const element = document.getElementById(campo);
                if (status === 'PENDENTE' && isAdmin1) {
                    element.disabled = false;
                    element.classList.add('editable-field');
                } else {
                    element.disabled = true;
                    element.classList.remove('editable-field');
                }
            });
            
            // Campo de clientes interrompidos - editável por admin1 até finalizar
            const clientesField = document.getElementById('editClientesInterrompidos');
            if (isAdmin1 && !isFinalizado) {
                clientesField.disabled = false;
                clientesField.classList.add('editable-field');
            } else {
                clientesField.disabled = true;
                clientesField.classList.remove('editable-field');
            }
            
            // Campo de relatório - sempre editável até finalizar
            const relatorioField = document.getElementById('editRelatorio');
            if (!isFinalizado) {
                relatorioField.disabled = false;
                relatorioField.classList.add('editable-field');
            } else {
                relatorioField.disabled = true;
                relatorioField.classList.remove('editable-field');
            }
            // Em mobile, rolar até o relatório, que é o campo principal nos status > PENDENTE
            try {
                if (window.innerWidth <= 992) {
                    relatorioField.scrollIntoView({behavior:'smooth', block:'center'});
                }
            } catch(e){}
            
            // Mostrar/ocultar campo de clientes interrompidos baseado no status
            const clientesGroup = document.getElementById('clientesInterrompidosGroup');
            clientesGroup.style.display = 'block'; // Sempre mostrar para visualização
            
            
            // Configurar botões de ação
            document.getElementById('salvarBtn').style.display = (status !== 'FINALIZADO' && status !== 'CANCELADO') ? 'inline-flex' : 'none';
            document.getElementById('validarBtn').style.display = (status === 'PENDENTE' && isAdmin1) ? 'inline-flex' : 'none';
            document.getElementById('alocarBtn').style.display = (status === 'ENVIADO') ? 'inline-flex' : 'none';
            document.getElementById('finalizarBtn').style.display = (status === 'RECURSO_ALOCADO') ? 'inline-flex' : 'none';

            const retroBtn = document.getElementById('retroagirBtn');
            if (retroBtn) retroBtn.style.display = (isAdmin1 && (status === 'ENVIADO' || status === 'RECURSO_ALOCADO' || status === 'FINALIZADO')) ? 'inline-flex' : 'none';

            const cancBtn = document.getElementById('cancelarBtn');
            if (cancBtn) cancBtn.style.display = (isAdmin1 && status === 'PENDENTE') ? 'inline-flex' : 'none';

            // Mostrar modal

            document.getElementById('editModal').classList.add('show');
        }

        
        // Retroagir status (admin1)
        async function retroagirStatus() {
            try {
                const id = document.getElementById('editId').value;
                const ref = db.collection('acionamentos').doc(id);
                const snap = await ref.get();
                if (!snap.exists) return;
                const dados = snap.data();
                const atual = dados.status || 'PENDENTE';
                let novo = atual;
                if (atual === 'ENVIADO') novo = 'PENDENTE';
                else if (atual === 'RECURSO_ALOCADO') novo = 'ENVIADO';
                else if (atual === 'FINALIZADO') novo = 'RECURSO_ALOCADO';
                else return;
                
                const dateParts = getLocalDateParts();
                const usuario = (currentUser && (currentUser.name || currentUser.username)) || 'Desconhecido';
                const historicoEntry = {
                    data: dateParts.date,
                    hora: dateParts.time,
                    usuario: usuario,
                    acao: `Retroagir status: ${atual} → ${novo}`,
                    detalhes: {
                        status_anterior: atual,
                        status_novo: novo
                    }
                };
                await ref.update({
                    status: novo,
                    historico: firebase.firestore.FieldValue.arrayUnion(historicoEntry)
                });
                alert('Status retroagido com sucesso.');
                closeEditModal();
                loadAcionamentos();
            } catch (err) {
                console.error(err);
                alert('Erro ao retroagir status: ' + err.message);
            }
        }

        // Cancelar acionamento (admin1)
        async function cancelarAcionamento() {
            try {
                const id = document.getElementById('editId').value;
                const ref = db.collection('acionamentos').doc(id);
                const snap = await ref.get();
                if (!snap.exists) return;
                const dados = snap.data();
                const atual = dados.status || 'PENDENTE';
                if (atual !== 'PENDENTE') {
                    alert('Só é possível cancelar quando o acionamento está PENDENTE.');
                    return;
                }
                const motivo = prompt('Confirme o cancelamento. Opcionalmente, informe um motivo:');
                const dateParts = getLocalDateParts();
                const usuario = (currentUser && (currentUser.name || currentUser.username)) || 'Desconhecido';
                const historicoEntry = {
                    data: dateParts.date,
                    hora: dateParts.time,
                    usuario: usuario,
                    acao: 'Cancelamento de acionamento',
                    motivo: motivo || null,
                    detalhes: {
                        status_anterior: atual,
                        status_novo: 'CANCELADO'
                    }
                };
                await ref.update({
                    status: 'CANCELADO',
                    data_cancelamento: new Date().toISOString(),
                    historico: firebase.firestore.FieldValue.arrayUnion(historicoEntry)
                });
                alert('Acionamento cancelado.');
                closeEditModal();
                loadAcionamentos();
            } catch (err) {
                console.error(err);
                alert('Erro ao cancelar acionamento: ' + err.message);
            }
        }

        // Função para fechar modal

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        // Função para salvar edição
        async function salvarEdicao() {
            try {
                const id = document.getElementById('editId').value;
                const acionamentoRef = db.collection('acionamentos').doc(id);
                const doc = await acionamentoRef.get();
                const historicoAtual = doc.exists ? doc.data().historico || [] : [];

                
                // Bloqueio extra: não permitir edição em FINALIZADO/CANCELADO
                const statusAtual = doc.exists ? (doc.data().status || 'PENDENTE') : 'PENDENTE';
                if (statusAtual === 'FINALIZADO' || statusAtual === 'CANCELADO') {
                    alert('Não é possível editar quando o acionamento está FINALIZADO ou CANCELADO.');
                    return;
                }
const dateParts = getLocalDateParts();
                // Sanitizador para remover/converter undefined em null (Firestore não aceita undefined)
                const limparUndefinedDeep = (v) => {
                    if (Array.isArray(v)) return v.map(limparUndefinedDeep);
                    if (v && typeof v === 'object') {
                        const o = {};
                        Object.keys(v).forEach(k => {
                            const vv = limparUndefinedDeep(v[k]);
                            if (vv !== undefined) o[k] = vv;
                        });
                        return o;
                    }
                    return v === undefined ? null : v;
                };
                const novoHistorico = {
                    data: dateParts.date,
                    hora: dateParts.time,
                    usuario: currentUser.name + ' (' + currentUser.username + ')',
                    acao: 'Dados editados',
                    detalhes: {
                        campos_alterados: []
                    }
                };

                // Obter valores atuais para comparação
                const dadosAtuais = doc.exists ? doc.data() : {};
                const dadosAtualizados = {
                    data_criacao_ocorrencia: (document.getElementById('editDataCriacao')?.value ?? ''),
                    horario_criacao_ocorrencia: (document.getElementById('editHorarioCriacao')?.value ?? ''),
                    equipe: (document.getElementById('editEquipe')?.value ?? ''),
                    tipo_equipe: (document.getElementById('editTipoEquipe')?.value ?? ''),
                    tipo_defeito: (document.getElementById('editTipoDefeito')?.value ?? ''),
                    alimentador: (document.getElementById('editAlimentador')?.value ?? ''),
                    tipo_referencia: (document.getElementById('editTipoReferencia')?.value ?? ''),
                    numero_referencia: (document.getElementById('editNumeroReferencia')?.value ?? ''),
                    clientes_interrompidos: (document.getElementById('editClientesInterrompidos')?.value ?? ''),
                    relatorio_ocorrencia: (document.getElementById('editRelatorio')?.value ?? ''),
                    materiais_necessarios: (document.getElementById('editMateriais')?.value ?? ''),
                    historico: [...historicoAtual, limparUndefinedDeep(novoHistorico)]
                };

                // Identificar campos alterados
                const campos = Object.keys(dadosAtualizados);
                // Mapeia nomes internos para rótulos mais amigáveis no histórico
                const labelMap = {
                    data_criacao_ocorrencia: 'Data de Criação da Ocorrência',
                    horario_criacao_ocorrencia: 'Horário de Criação da Ocorrência',
                    equipe: 'Equipe',
                    tipo_equipe: 'Tipo de Equipe',
                    tipo_defeito: 'Tipo de Defeito',
                    alimentador: 'Alimentador',
                    tipo_referencia: 'Tipo de Referência',
                    numero_referencia: 'Número de Referência',
                    clientes_interrompidos: 'Clientes Interrompidos',
                    relatorio_ocorrencia: 'Relatório da Ocorrência',
                    materiais_necessarios: 'Materiais Necessários'
                };
                campos.forEach(campo => {
                    if (campo !== 'historico' && dadosAtuais[campo] !== dadosAtualizados[campo]) {
                        novoHistorico.detalhes.campos_alterados.push({
                            campo: campo,
                            label: labelMap[campo] || campo,
                            valor_anterior: dadosAtuais[campo],
                            valor_novo: dadosAtualizados[campo]
                        });
                    }
                });

                // Atualizar apenas se houver alterações
                if (novoHistorico.detalhes.campos_alterados.length > 0) {
                    // enviar apenas campos modificados + historico
                    const dadosAtualizadosLimpos = {};
                    Object.keys(dadosAtualizados).forEach(k => {
                        if (k === 'historico') { dadosAtualizadosLimpos[k] = dadosAtualizados[k]; return; }
                        const antes = (dadosAtuais || {})[k];
                        const depois = dadosAtualizados[k];
                        if (String(antes ?? '') !== String(depois ?? '')) {
                            dadosAtualizadosLimpos[k] = (depois === undefined ? null : depois);
                        }
                    });
                    await acionamentoRef.update(dadosAtualizadosLimpos);
                    
                    closeEditModal();
                    loadAcionamentos();
                    
                    alert('Acionamento atualizado com sucesso!');
                } else {
                    alert('Nenhuma alteração foi feita.');
                }
            } catch (error) {
                console.error('Erro ao salvar edição:', error);
                alert('Erro ao salvar alterações: ' + (error && (error.message || error.code) || 'desconhecido'));
            }
        }

        // Função para validar acionamento
        async function validarAcionamento() {
            try {
                const id = document.getElementById('editId').value;
                
                const acionamentoRef = db.collection('acionamentos').doc(id);
                const doc = await acionamentoRef.get();
                const historicoAtual = doc.exists ? doc.data().historico || [] : [];

                const dateParts = getLocalDateParts();
                const novoHistorico = {
                    data: dateParts.date,
                    hora: dateParts.time,
                    usuario: currentUser.name + ' (' + currentUser.username + ')',
                    acao: 'Acionamento validado e enviado',
                    detalhes: {
                        status_anterior: doc.exists ? doc.data().status : null,
                        status_novo: 'ENVIADO'
                    }
                };

                await acionamentoRef.update({
                    status: 'ENVIADO',
                    data_validacao: new Date().toISOString(),
                    validado_por: currentUser.username,
                    historico: [...historicoAtual, novoHistorico]
                });
                
                closeEditModal();
                loadAcionamentos();
                
                alert('Acionamento validado e enviado com sucesso!');
            } catch (error) {
                console.error('Erro ao validar acionamento:', error);
                alert('Erro ao validar acionamento.');
            }
        }

        // Função para alocar recurso
        async function alocarRecurso() {
            const equipe = prompt('Digite a equipe a ser alocada:');
            if (!equipe) return;
            
            try {
                const id = document.getElementById('editId').value;
                
                const acionamentoRef = db.collection('acionamentos').doc(id);
                const doc = await acionamentoRef.get();
                const historicoAtual = doc.exists ? doc.data().historico || [] : [];

                const dateParts = getLocalDateParts();
                const novoHistorico = {
                    data: dateParts.date,
                    hora: dateParts.time,
                    usuario: currentUser.name + ' (' + currentUser.username + ')',
                    acao: `Recurso alocado - Equipe: ${equipe}`,
                    detalhes: {
                        status_anterior: doc.exists ? doc.data().status : null,
                        status_novo: 'RECURSO_ALOCADO'
                    }
                };

                await acionamentoRef.update({
                    status: 'RECURSO_ALOCADO',
                    data_alocacao: new Date().toISOString(),
                    alocado_por: currentUser.username,
                    equipe: equipe,
                    historico: [...historicoAtual, novoHistorico]
                });
                
                closeEditModal();
                loadAcionamentos();
                
                alert('Recurso alocado com sucesso!');
            } catch (error) {
                console.error('Erro ao alocar recurso:', error);
                alert('Erro ao alocar recurso.');
            }
        }

        // Função para finalizar acionamento
        async function finalizarAcionamento() {
            try {
                const id = document.getElementById('editId').value;
                
                const acionamentoRef = db.collection('acionamentos').doc(id);
                const doc = await acionamentoRef.get();
                const historicoAtual = doc.exists ? doc.data().historico || [] : [];

                const dateParts = getLocalDateParts();
                const novoHistorico = {
                    data: dateParts.date,
                    hora: dateParts.time,
                    usuario: currentUser.name + ' (' + currentUser.username + ')',
                    acao: 'Acionamento finalizado',
                    detalhes: {
                        status_anterior: doc.exists ? doc.data().status : null,
                        status_novo: 'FINALIZADO'
                    }
                };

                await acionamentoRef.update({
                    status: 'FINALIZADO',
                    data_finalizacao: new Date().toISOString(),
                    finalizado_por: currentUser.username,
                    historico: [...historicoAtual, novoHistorico]
                });
                
                closeEditModal();
                loadAcionamentos();
                
                alert('Acionamento finalizado com sucesso!');
            } catch (error) {
                console.error('Erro ao finalizar:', error);
                alert('Erro ao finalizar acionamento.');
            }
        }

        // Função para carregar dashboard
        
function loadDashboard() {
    try {
        // KPIs
        document.getElementById('kpiPendentes').textContent = acionamentos.filter(a=>a.status==='PENDENTE').length;
        document.getElementById('kpiEnviados').textContent = acionamentos.filter(a=>a.status==='ENVIADO').length;
        document.getElementById('kpiRecurso').textContent = acionamentos.filter(a=>a.status==='RECURSO_ALOCADO').length;
        // Contabilizar finalizados e cancelados juntos no KPI
        document.getElementById('kpiFinalizados').textContent = acionamentos.filter(a => a.status === 'FINALIZADO' || a.status === 'CANCELADO').length;
        document.getElementById('kpiTodos').textContent = acionamentos.length;

        const diffs = { 'Pendente → Enviado': [], 'Enviado → Recurso': [], 'Recurso → Finalizado': [] };

        acionamentos.forEach(a => {
            if (a.data_criacao_ocorrencia && a.data_criacao) {
                const ini = a.horario_criacao_ocorrencia ? new Date(`${a.data_criacao_ocorrencia}T${a.horario_criacao_ocorrencia}`) : new Date(a.data_criacao_ocorrencia);
                const fim = new Date(a.data_criacao);
                const ms = fim - ini; if (!isNaN(ms) && ms >= 0) diffs['Pendente → Enviado'].push(ms);
            }
            if (a.data_criacao && a.data_alocacao) {
                const ms = new Date(a.data_alocacao) - new Date(a.data_criacao);
                if (!isNaN(ms) && ms >= 0) diffs['Enviado → Recurso'].push(ms);
            }
            if (a.data_alocacao && a.data_finalizacao) {
                let fim = new Date(a.data_finalizacao);
                if (a.hora_finalizacao) { const [hh,mm]=a.hora_finalizacao.split(':'); fim.setHours(parseInt(hh||'0'), parseInt(mm||'0')); }
                const ms = fim - new Date(a.data_alocacao);
                if (!isNaN(ms) && ms >= 0) diffs['Recurso → Finalizado'].push(ms);
            }
        });

        const avgHours = (arr) => arr.length ? Math.round((arr.reduce((s,v)=>s+v,0)/arr.length)/(1000*60*60)) : 0;
        const labels = Object.keys(diffs);
        const values = labels.map(k => avgHours(diffs[k]));

        const ctx = document.getElementById('tempoStatusChart').getContext('2d');
        if (charts.tempoStatus) charts.tempoStatus.destroy();
        charts.tempoStatus = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Média (h)', data: values }] },
            options: { plugins: { datalabels: { anchor: 'end', align: 'end', formatter: (v)=> v + 'h' } }, scales: { y: { beginAtZero: true } } }
        });
    } catch(e){ console.error('Erro no dashboard:', e); }
}


        // Função para filtrar por status
        function filterByStatus(status) {
            currentFilter = status;
            
            // Atualizar KPIs ativos
            document.querySelectorAll('.kpi-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`[data-status="${status}"]`).classList.add('active');
            
            // Atualizar gráficos
            updateCharts();
        }

        // Função para criar gráficos
        function createCharts() {
            // Destruir gráficos existentes
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            // Gráfico de distribuição por tipo de defeito
            const tipoDefeitoData = getTipoDefeitoData();
            const ctx4 = document.getElementById('tipoDefeitoChart').getContext('2d');
            charts.tipoDefeito = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: tipoDefeitoData.labels,
                    datasets: [{
                        label: 'Quantidade',
                        data: tipoDefeitoData.data,
                        backgroundColor: colorPalette.slice(0, tipoDefeitoData.labels.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            display: true,
                            color: '#000',
                            font: { weight: 'bold' },
                            formatter: function(value) {
                                return value > 0 ? value : '';
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Gráfico Top 5 acionamentos por clientes interrompidos
            const topClientesData = getTopClientesData();
            const ctx5 = document.getElementById('topClientesChart').getContext('2d');
            charts.topClientes = new Chart(ctx5, {
                type: 'bar',
                data: {
                    labels: topClientesData.labels,
                    datasets: [{
                        label: 'Clientes Interrompidos',
                        data: topClientesData.data,
                        backgroundColor: colorPalette.slice(0, topClientesData.labels.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            display: true,
                            color: '#000',
                            font: { weight: 'bold' },
                            formatter: function(value) {
                                return value > 0 ? value : '';
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Gráfico Top 10 alimentadores por acionamentos
            const topAlimentadoresData = getTopAlimentadoresData();
            const ctx6 = document.getElementById('topAlimentadoresChart').getContext('2d');
            charts.topAlimentadores = new Chart(ctx6, {
                type: 'bar',
                data: {
                    labels: topAlimentadoresData.labels,
                    datasets: [{
                        label: 'Acionamentos',
                        data: topAlimentadoresData.data,
                        backgroundColor: colorPalette.slice(0, topAlimentadoresData.labels.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            display: true,
                            color: '#000',
                            font: { weight: 'bold' },
                            formatter: function(value) {
                                return value > 0 ? value : '';
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Gráfico Top 5 maior tempo desde a criação da ocorrência
            const topTempoData = getTopTempoData();
            const ctx7 = document.getElementById('topTempoChart').getContext('2d');
            charts.topTempo = new Chart(ctx7, {
                type: 'bar',
                data: {
                    labels: topTempoData.labels,
                    datasets: [{
                        label: 'Tempo (h)',
                        data: topTempoData.data,
                        backgroundColor: colorPalette.slice(0, topTempoData.labels.length),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            display: true,
                            color: '#000',
                            font: { weight: 'bold' },
                            formatter: function(value) {
                                return value > 0 ? value.toFixed(2) + 'h' : '';
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            // Gráfico de tempo entre status
            const ctx2 = document.getElementById('tempoStatusChart').getContext('2d');
            charts.tempoStatus = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Pendente → Enviado', 'Enviado → Recurso', 'Recurso → Finalizado'],
                    datasets: [{
                        label: 'Tempo Médio (horas)',
                        data: getTempoMedioTransicoes(),
                        backgroundColor: [
                            '#ff9800',
                            '#2196f3',
                            '#4caf50'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        datalabels: {
                            display: true,
                            color: '#000',
                            font: {
                                weight: 'bold'
                            },
                            formatter: function(value) {
                                return value > 0 ? value.toFixed(2) + 'h' : '';
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + 'h';
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico por tipo de equipe
            const ctx3 = document.getElementById('tipoEquipeChart').getContext('2d');
            charts.tipoEquipe = new Chart(ctx3, {
                type: 'doughnut',
                data: {
                    labels: ['Pesada', 'Poda', 'Linha Viva', 'Leve'],
                    datasets: [{
                        data: getTipoEquipeData(),
                        backgroundColor: ['#ff9800', '#4caf50', '#2196f3', '#f44336']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        datalabels: {
                            display: true,
                            color: '#fff',
                            font: {
                                weight: 'bold'
                            },
                            formatter: function(value, context) {
                                return value > 0 ? value : '';
                            }
                        }
                    }
                }
            });
        }

        
// Função para calcular tempo médio entre transições de status (versão reforçada)
function getTempoMedioTransicoes() {
    const transicoes = {
        pendenteEnviado: { total: 0, count: 0 },
        enviadoRecurso: { total: 0, count: 0 },
        recursoFinalizado: { total: 0, count: 0 }
    };

    // Excluir finalizados e cancelados e aplicar filtro
    let tempData = acionamentos.filter(a => a.status !== 'FINALIZADO' && a.status !== 'CANCELADO');
    if (currentFilter !== 'TODOS') {
        tempData = tempData.filter(a => a.status === currentFilter);
    }

    tempData.forEach(acionamento => {
        const historico = acionamento.historico || [];
        let dataEnviado = null, dataRecurso = null, dataFinalizado = null;

        // Encontrar datas de transição (procura a primeira ocorrência relevante)
        historico.forEach(evento => {
            const prev = evento.detalhes?.status_anterior;
            const next = evento.detalhes?.status_novo;
            const evDate = evento.data;
            const evHora = evento.hora;
            if (!evDate) return;
            if (!dataEnviado && prev === 'PENDENTE' && next === 'ENVIADO') {
                dataEnviado = parseDateTimeLocal(evDate, evHora) || new Date(`${evDate}T${evHora}`);
            } else if (!dataRecurso && prev === 'ENVIADO' && next === 'RECURSO_ALOCADO') {
                dataRecurso = parseDateTimeLocal(evDate, evHora) || new Date(`${evDate}T${evHora}`);
            } else if (!dataFinalizado && prev === 'RECURSO_ALOCADO' && next === 'FINALIZADO') {
                dataFinalizado = parseDateTimeLocal(evDate, evHora) || new Date(`${evDate}T${evHora}`);
            }
        });

        // Calcular tempo de criação para enviado
        if (dataEnviado) {
            const dataCriacao = parseDateTimeLocal(acionamento.data_criacao_ocorrencia, acionamento.horario_criacao_ocorrencia) || new Date(`${acionamento.data_criacao_ocorrencia}T${acionamento.horario_criacao_ocorrencia}`);
            const diffMs = dataEnviado - dataCriacao;
            if (diffMs > 0) {
                transicoes.pendenteEnviado.total += diffMs;
                transicoes.pendenteEnviado.count++;
            } else {
                // dados inconsistentes; ignorar este registro
                console.warn('Ignorado diff negativo pendente->enviado para', acionamento.id || acionamento.numero_ocorrencia);
            }
        }

        // Calcular tempo de enviado para recurso
        if (dataRecurso && dataEnviado) {
            const diffMs = dataRecurso - dataEnviado;
            if (diffMs > 0) {
                transicoes.enviadoRecurso.total += diffMs;
                transicoes.enviadoRecurso.count++;
            } else {
                console.warn('Ignorado diff negativo enviado->recurso para', acionamento.id || acionamento.numero_ocorrencia);
            }
        }

        // Calcular tempo de recurso para finalizado
        if (dataFinalizado && dataRecurso) {
            const diffMs = dataFinalizado - dataRecurso;
            if (diffMs > 0) {
                transicoes.recursoFinalizado.total += diffMs;
                transicoes.recursoFinalizado.count++;
            } else {
                console.warn('Ignorado diff negativo recurso->finalizado para', acionamento.id || acionamento.numero_ocorrencia);
            }
        }
    });

    // Calcular médias em horas (converter ms -> horas)
    const medias = [
        transicoes.pendenteEnviado.count > 0 ? transicoes.pendenteEnviado.total / (transicoes.pendenteEnviado.count * 3600000) : 0,
        transicoes.enviadoRecurso.count > 0 ? transicoes.enviadoRecurso.total / (transicoes.enviadoRecurso.count * 3600000) : 0,
        transicoes.recursoFinalizado.count > 0 ? transicoes.recursoFinalizado.total / (transicoes.recursoFinalizado.count * 3600000) : 0
    ];

    return medias;
}


        // Função para atualizar gráficos
        function updateCharts() {
            if (charts.tempoStatus) {
                charts.tempoStatus.data.datasets[0].data = getTempoMedioTransicoes();
                charts.tempoStatus.update();
            }
            
            if (charts.tipoEquipe) {
                charts.tipoEquipe.data.datasets[0].data = getTipoEquipeData();
                charts.tipoEquipe.update();
            }

            // Atualizar gráfico por tipo de defeito
            if (charts.tipoDefeito) {
                const tipoDefeitoData = getTipoDefeitoData();
                charts.tipoDefeito.data.labels = tipoDefeitoData.labels;
                charts.tipoDefeito.data.datasets[0].data = tipoDefeitoData.data;
                charts.tipoDefeito.data.datasets[0].backgroundColor = colorPalette.slice(0, tipoDefeitoData.labels.length);
                charts.tipoDefeito.update();
            }

            // Atualizar gráfico Top 5 clientes interrompidos
            if (charts.topClientes) {
                const topClientesData = getTopClientesData();
                charts.topClientes.data.labels = topClientesData.labels;
                charts.topClientes.data.datasets[0].data = topClientesData.data;
                charts.topClientes.data.datasets[0].backgroundColor = colorPalette.slice(0, topClientesData.labels.length);
                charts.topClientes.update();
            }

            // Atualizar gráfico Top 10 alimentadores
            if (charts.topAlimentadores) {
                const topAlimentadoresData = getTopAlimentadoresData();
                charts.topAlimentadores.data.labels = topAlimentadoresData.labels;
                charts.topAlimentadores.data.datasets[0].data = topAlimentadoresData.data;
                charts.topAlimentadores.data.datasets[0].backgroundColor = colorPalette.slice(0, topAlimentadoresData.labels.length);
                charts.topAlimentadores.update();
            }

            // Atualizar gráfico Top 5 tempos desde criação
            if (charts.topTempo) {
                const topTempoData = getTopTempoData();
                charts.topTempo.data.labels = topTempoData.labels;
                charts.topTempo.data.datasets[0].data = topTempoData.data;
                charts.topTempo.data.datasets[0].backgroundColor = colorPalette.slice(0, topTempoData.labels.length);
                charts.topTempo.update();
            }
        }

        // Função para obter dados por tipo de equipe
        function getTipoEquipeData() {
            // Excluir finalizados e cancelados e aplicar filtro
            let filteredData = acionamentos.filter(a => a.status !== 'FINALIZADO' && a.status !== 'CANCELADO');
            
            if (currentFilter !== 'TODOS') {
                filteredData = filteredData.filter(a => a.status === currentFilter);
            }
            
            const pesada = filteredData.filter(a => a.tipo_equipe?.includes('PESADA')).length;
            const poda = filteredData.filter(a => a.tipo_equipe?.includes('PODA')).length;
            const linhaViva = filteredData.filter(a => a.tipo_equipe?.includes('LINHA_VIVA')).length;
            const leve = filteredData.filter(a => a.tipo_equipe === 'LEVE').length;
            
            return [pesada, poda, linhaViva, leve];
        }

        // Função para agrupar dados por tipo de defeito (excluindo finalizados e cancelados)
        function getTipoDefeitoData() {
            let data = acionamentos.filter(a => a.status !== 'FINALIZADO' && a.status !== 'CANCELADO');
            if (currentFilter !== 'TODOS') {
                data = data.filter(a => a.status === currentFilter);
            }
            const counts = {};
            data.forEach(a => {
                const tipo = a.tipo_defeito || 'Indefinido';
                counts[tipo] = (counts[tipo] || 0) + 1;
            });
            const labels = Object.keys(counts);
            const values = Object.values(counts);
            return { labels: labels, data: values };
        }

        // Função para obter top 5 acionamentos com mais clientes interrompidos
        function getTopClientesData() {
            let data = acionamentos.filter(a => a.status !== 'FINALIZADO' && a.status !== 'CANCELADO');
            if (currentFilter !== 'TODOS') {
                data = data.filter(a => a.status === currentFilter);
            }
            // Converter clientes_interrompidos em número e remover valores não numéricos
            const list = data.map(a => {
                const valor = parseInt(a.clientes_interrompidos || 0);
                return { id: a.numero_ocorrencia || a.id, valor: isNaN(valor) ? 0 : valor };
            });
            // Ordenar por valor descendente e pegar top 5
            list.sort((a, b) => b.valor - a.valor);
            const top = list.slice(0, 5);
            return { labels: top.map(item => item.id), data: top.map(item => item.valor) };
        }

        // Função para obter top 10 alimentadores com mais acionamentos
        function getTopAlimentadoresData() {
            let data = acionamentos.filter(a => a.status !== 'FINALIZADO' && a.status !== 'CANCELADO');
            if (currentFilter !== 'TODOS') {
                data = data.filter(a => a.status === currentFilter);
            }
            const counts = {};
            data.forEach(a => {
                const key = a.alimentador || 'Indefinido';
                counts[key] = (counts[key] || 0) + 1;
            });
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 10);
            return { labels: sorted.map(item => item[0]), data: sorted.map(item => item[1]) };
        }

        // Função auxiliar para calcular horas desde a criação da ocorrência
        function horasDesdeCriacao(acionamento) {
            if (!acionamento.data_criacao_ocorrencia) return 0;
            const inicio = acionamento.horario_criacao_ocorrencia ? new Date(`${acionamento.data_criacao_ocorrencia}T${acionamento.horario_criacao_ocorrencia}`) : new Date(acionamento.data_criacao_ocorrencia);
            if (isNaN(inicio.getTime())) return 0;
            const agora = new Date();
            const diffMs = agora - inicio;
            return diffMs / 3600000; // horas
        }

        // Função para obter top 5 acionamentos com maior tempo desde a criação
        function getTopTempoData() {
            let data = acionamentos.filter(a => a.status !== 'FINALIZADO' && a.status !== 'CANCELADO');
            if (currentFilter !== 'TODOS') {
                data = data.filter(a => a.status === currentFilter);
            }
            const list = data.map(a => {
                return { id: a.numero_ocorrencia || a.id, tempo: horasDesdeCriacao(a) };
            });
            list.sort((a, b) => b.tempo - a.tempo);
            const top = list.slice(0, 5);
            return { labels: top.map(item => item.id), data: top.map(item => parseFloat(item.tempo.toFixed(2))) };
        }

        // Função para exportar para Excel
        function exportToExcel() {
            try {
                // Filtrar dados baseado na seção atual e permissões
                let dataToExport = acionamentos;
                
                if (currentStatus !== 'TODAS_OCORRENCIAS' && currentStatus !== 'DASHBOARD') {
                    const statusMap = {
                        'ACIONAMENTOS_PENDENTES': 'PENDENTE',
                        'ACIONAMENTOS_ENVIADOS': 'ENVIADO',
                        'COM_RECURSO_ALOCADO': 'RECURSO_ALOCADO',
                        'OCORRENCIAS_FINALIZADAS': 'FINALIZADO'
                    };
                    if (currentStatus === 'OCORRENCIAS_FINALIZADAS') {
                        // Exportar finalizados e cancelados juntos
                        dataToExport = acionamentos.filter(a => a.status === 'FINALIZADO' || a.status === 'CANCELADO');
                    } else {
                        dataToExport = acionamentos.filter(a => a.status === statusMap[currentStatus]);
                    }
                } else {
                    // Para ADMIN2, filtrar acionamentos pendentes
                    if (currentUser.role === 'admin2') {
                        dataToExport = acionamentos.filter(a => a.status !== 'PENDENTE');
                    }
                }
                
                // Função auxiliar para extrair dados do histórico por status
                function getHistoricoByStatus(historico, status) {
                    if (!historico || !Array.isArray(historico)) return { data: '', hora: '', usuario: '' };
                    
                    const entrada = historico.find(h => h.detalhes?.status_novo === status);
                    return entrada ? {
                        data: entrada.data || '',
                        hora: entrada.hora || '',
                        usuario: entrada.usuario || ''
                    } : { data: '', hora: '', usuario: '' };
                }
                
                // Preparar dados para exportação
                const exportData = dataToExport.map(acionamento => {
                    const historico = acionamento.historico || [];
                    
                    // Extrair dados do histórico para cada status
                    const pendente = getHistoricoByStatus(historico, 'PENDENTE');
                    const enviado = getHistoricoByStatus(historico, 'ENVIADO');
                    const recursoAlocado = getHistoricoByStatus(historico, 'RECURSO_ALOCADO');
                    const finalizado = getHistoricoByStatus(historico, 'FINALIZADO');
                    
                    return {
                        'Número da Ocorrência': acionamento.numero_ocorrencia || acionamento.id,
                        'Data de Criação': acionamento.data_criacao_ocorrencia || '',
                        'Horário de Criação': acionamento.horario_criacao_ocorrencia || '',
                        'Equipe': acionamento.equipe || '',
                        'Tipo de Equipe': acionamento.tipo_equipe || '',
                        'Tipo de Defeito': acionamento.tipo_defeito || '',
                        'Alimentador': acionamento.alimentador || '',
                        'Tipo de Referência': acionamento.tipo_referencia || '',
                        'Número da Referência': acionamento.numero_referencia || '',
                        'Clientes Interrompidos': acionamento.clientes_interrompidos || '',
                        'Relatório da Ocorrência': acionamento.relatorio_ocorrencia || '',
                        'Materiais Necessários': acionamento.materiais_necessarios || '',
                        'Status': getStatusLabel(acionamento.status),
                        
                        // Colunas do histórico de status
                        'Data Pendente': pendente.data,
                        'Hora Pendente': pendente.hora,
                        'Usuário Pendente': pendente.usuario,
                        
                        'Data Enviado': enviado.data,
                        'Hora Enviado': enviado.hora,
                        'Usuário Enviado': enviado.usuario,
                        
                        'Data Com Recurso Alocado': recursoAlocado.data,
                        'Hora Com Recurso Alocado': recursoAlocado.hora,
                        'Usuário Com Recurso Alocado': recursoAlocado.usuario,
                        
                        'Data Finalizado': finalizado.data,
                        'Hora Finalizado': finalizado.hora,
                        'Usuário Finalizado': finalizado.usuario,
                        
                        // Colunas originais mantidas para compatibilidade
                        'Data de Acionamento': formatarData(acionamento.data_acionamento) || '',
                        'Data de Envio': formatarData(acionamento.data_envio) || '',
                        'Data de Alocação da Turma': formatarData(acionamento.data_alocacao_turma) || '',
                        'Data de Finalização da Ocorrência': formatarData(acionamento.data_finalizacao) || '',
                        'Tempo desde Criação': calcularTempoDecorrido(acionamento.data_criacao_ocorrencia, acionamento.horario_criacao_ocorrencia, acionamento),
                        'Tempo desde Acionamento': calcularTempoDecorrido(acionamento.data_criacao, null, acionamento),
                        'Validado por': acionamento.validado_por || '',
                        'Alocado por': acionamento.alocado_por || '',
                        'Finalizado por': acionamento.finalizado_por || ''
                    };
                });
                
                // Criar workbook
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Acionamentos');
                
                // Gerar nome do arquivo
                const now = new Date();
                const fileName = `acionamentos_${now.getFullYear()}_${(now.getMonth() + 1).toString().padStart(2, '0')}_${now.getDate().toString().padStart(2, '0')}.xlsx`;
                
                // Fazer download
                XLSX.writeFile(wb, fileName);
                
                alert('Relatório Excel exportado com sucesso!');
            } catch (error) {
                console.error('Erro ao exportar Excel:', error);
                alert('Erro ao exportar relatório Excel.');
            }
        }

        // Funções para mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
        }

        // Carregar acionamentos inicialmente
        if (firebaseInitialized) {
            loadAcionamentos();
        }
    </script>
</body>
</html>