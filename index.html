<!DOCTYPE html>

<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Sistema de Acionamentos CLB</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&amp;family=Open+Sans:wght@400;600&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
    :root {
      /* Cores primárias - Laranja como cor predominante */
      --primary-50: #fff3e0;
      --primary-100: #ffe0b2;
      --primary-200: #ffcc80;
      --primary-300: #ffb74d;
      --primary-400: #ffa726;
      --primary-500: #ff9800;  /* Cor principal - Laranja */
      --primary-600: #fb8c00;
      --primary-700: #f57c00;
      --primary-800: #ef6c00;
      --primary-900: #e65100;
      
      /* Cores secundárias */
      --secondary-500: #2196f3;  /* Azul para destaque */
      
      /* Cores neutras */
      --neutral-50: #fafafa;
      --neutral-100: #f5f5f5;
      --neutral-200: #eeeeee;
      --neutral-300: #e0e0e0;
      --neutral-400: #bdbdbd;
      --neutral-500: #9e9e9e;
      --neutral-600: #757575;
      --neutral-700: #616161;
      --neutral-800: #424242;
      --neutral-900: #212121;
      
      /* Cores de feedback */
      --success: #4caf50;
      --warning: #ff9800;
      --error: #f44336;
      --info: #2196f3;
      
      /* Compatibilidade com variáveis antigas */
      --primary-color: var(--primary-600);
      --primary-dark: var(--primary-700);
      --primary-light: var(--primary-400);
      --secondary-color: var(--success);
      --secondary-dark: #2e7d32;
      --danger-color: var(--error);
      --danger-dark: #d32f2f;
      --warning-color: var(--warning);
      --info-color: var(--info);
      --success-color: var(--success);
      --text-primary: var(--neutral-800);
      --text-secondary: var(--neutral-600);
      --text-light: var(--neutral-500);
      --bg-primary: #ffffff;
      --bg-secondary: var(--neutral-100);
      --bg-tertiary: var(--neutral-200);
      --border-color: var(--neutral-300);
      --border-light: var(--neutral-200);
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.08);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius-sm: 0.25rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --transition-speed: 0.2s;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      color: var(--text-primary);
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      color: var(--text-primary);
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 0 0 0.5rem 0;
      text-shadow: none;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.7;
      margin: 0;
      font-weight: 300;
      color: var(--text-secondary);
    }

    .main-card {
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      overflow: hidden;
      margin-bottom: 2rem;
    }

    .card-header {
      background-color: var(--primary-600);
      color: white;
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--border-light);
    }

    .card-header h2 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-body {
      padding: 2rem;
    }

    .form-grid {
      display: grid;
      gap: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group.half {
      grid-column: span 1;
    }

    .form-group.full {
      grid-column: span 2;
    }

    @media (min-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    label {
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .required {
      color: var(--error);
    }

    .input-wrapper {
      position: relative;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 1rem;
      font-family: inherit;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: all 0.2s ease;
      outline: none;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
      transform: translateY(-1px);
    }

    input:hover, select:hover, textarea:hover {
      border-color: var(--primary-light);
    }

    .input-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
      pointer-events: none;
    }

    .input-with-icon {
      padding-left: 2.5rem;
    }

    .reference-group {
      display: flex;
      gap: 0.5rem;
      align-items: end;
    }

    .reference-select {
      flex: 0 0 120px;
    }

    .reference-input {
      flex: 1;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: var(--radius-md);
      font-size: 1rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background-color: var(--primary-600);
      color: white;
    }

    .btn-primary:hover {
      background-color: var(--primary-700);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn:disabled:hover {
      transform: none;
      box-shadow: none;
    }

    .loading {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .success-message {
      background: var(--success);
      color: white;
      padding: 1rem;
      border-radius: var(--radius-md);
      margin-top: 1rem;
      text-align: center;
      font-weight: 500;
    }

    .error-message {
      background: var(--error);
      color: white;
      padding: 1rem;
      border-radius: var(--radius-md);
      margin-top: 1rem;
      text-align: center;
      font-weight: 500;
    }

    .readonly-field {
      background-color: var(--neutral-100);
      color: var(--text-secondary);
      cursor: not-allowed;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }

      .header h1 {
        font-size: 2rem;
      }

      .card-body {
        padding: 1.5rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .form-group.half,
      .form-group.full {
        grid-column: span 1;
      }

      .btn {
        width: 100%;
        margin-bottom: 0.5rem;
      }

      .reference-group {
        flex-direction: column;
        align-items: stretch;
      }

      .reference-select {
        flex: none;
      }
    }
</style>
</head>
<body>
<div class="container">
<div class="header">
<div style="width: 64px; height: 64px; background-color: var(--primary-600); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
<i class="fas fa-bolt" style="font-size: 32px; color: white;"></i>
</div>
<h1>Sistema de Acionamentos CLB</h1>
<p>Formulário de Registro de Ocorrências</p>
</div>
<div class="main-card">
<div class="card-header">
<h2><i class="fas fa-plus-circle"></i> Nova Ocorrência</h2>
</div>
<div class="card-body">
<form id="acionamentoForm" onsubmit="enviarAcionamento(event)">
<div class="form-grid">
<!-- Número da Ocorrência -->
<div class="form-group full">
<label for="numeroOcorrencia">
<i class="fas fa-hashtag"></i>
                Número da Ocorrência <span class="required">*</span>
</label>
<div class="input-wrapper">
<i class="fas fa-calendar input-icon"></i>
<input class="input-with-icon" id="numeroOcorrencia" placeholder="2025_08_000001" required="" type="text"/>
</div>
<small style="color: var(--text-secondary); margin-top: 0.25rem;">Formato: ANO_MÊS_NÚMERO (ex: 2025_08_000001)</small>
</div>
<!-- Data de Criação da Ocorrência -->
<div class="form-group half">
<label for="dataCriacao">
<i class="fas fa-calendar-alt"></i>
                Data de Criação da Ocorrência <span class="required">*</span>
</label>
<div class="input-wrapper">
<i class="fas fa-calendar-day input-icon"></i>
<input class="input-with-icon" id="dataCriacao" required="" type="date"/>
</div>
</div>
<!-- Horário de Criação da Ocorrência -->
<div class="form-group half">
<label for="horarioCriacao">
<i class="fas fa-clock"></i>
                Horário de Criação da Ocorrência <span class="required">*</span>
</label>
<div class="input-wrapper">
<i class="fas fa-clock input-icon"></i>
<input class="input-with-icon" id="horarioCriacao" required="" type="time"/>
</div>
</div>
<!-- Equipe -->
<div class="form-group half">
<label for="equipe">
<i class="fas fa-users"></i>
                Equipe <span class="required">*</span>
</label>
<select id="equipe" required="">
<option value="">Selecione a equipe</option>
<option value="CLB020049">CLB020049</option>
<option value="CLB020054">CLB020054</option>
<option value="CLB020056">CLB020056</option>
<option value="CLB020060A">CLB020060A</option>
<option value="CLB020060B">CLB020060B</option>
<option value="CLB020061A">CLB020061A</option>
<option value="CLB020061B">CLB020061B</option>
<option value="CLB020062A">CLB020062A</option>
<option value="CLB020062B">CLB020062B</option>
<option value="CLB020066A">CLB020066A</option>
<option value="CLB020066B">CLB020066B</option>
<option value="CLB020067">CLB020067</option>
<option value="CLB020855">CLB020855</option>
<option value="CLB201875">CLB201875</option>
<option value="CLBILH3063PD">CLBILH3063PD</option>
<option value="CLBILH3065PD">CLBILH3065PD</option>
<option value="CLBILH3066PD">CLBILH3066PD</option>
<option value="CLBILH3067PD">CLBILH3067PD</option>
<option value="STC2ILH018">STC2ILH018</option>
<option value="STC2ILH019">STC2ILH019</option>
<option value="STC2ILH01B">STC2ILH01B</option>
<option value="STC2PEILH016">STC2PEILH016</option>
<option value="STC2PEILH017">STC2PEILH017</option>
<option value="VTN2PEILH01C">VTN2PEILH01C</option>
<option value="VTN2PEILH01E">VTN2PEILH01E</option>
<option value="VTN2PEILH01F">VTN2PEILH01F</option>
<option value="EQUIPE NÃO LISTADA">EQUIPE NÃO LISTADA</option>
</select>
</div>
<!-- Tipo de Equipe -->
<div class="form-group half">
<label for="tipoEquipe">
<i class="fas fa-tools"></i>
                Tipo de Equipe <span class="required">*</span>
</label>
<select id="tipoEquipe" required="">
<option value="">Selecione o tipo</option>
<option value="PESADA">PESADA</option>
<option value="PODA">PODA</option>
<option value="LINHA_VIVA">LINHA VIVA</option>
<option value="LEVE">LEVE</option>
<option value="PESADA_PODA">PESADA+PODA</option>
<option value="PESADA_LINHA_VIVA">PESADA+LINHA VIVA</option>
<option value="LINHA_VIVA_PODA">LINHA VIVA+PODA</option>
</select>
</div>
<!-- Tipo de Defeito -->
<div class="form-group half">
<label for="tipoDefeito">
<i class="fas fa-exclamation-triangle"></i>
                Tipo de Defeito <span class="required">*</span>
</label>
<select id="tipoDefeito" required="">
<option value="">Selecione o defeito</option>
<option value="POSTE">POSTE</option>
<option value="TRAFO">TRAFO</option>
<option value="VAO_REDE">VÃO DE REDE</option>
<option value="PODA">PODA</option>
</select>
</div>
<!-- Referência Elétrica -->
<div class="form-group half">
<label for="referenciaEletrica">
<i class="fas fa-map-marker-alt"></i>
                Referência Elétrica <span class="required">*</span>
</label>
<div class="reference-group">
<div class="reference-select">
<select id="tipoReferencia" required="">
<option value="">Tipo</option>
<option value="PG">PG</option>
<option value="TRAFO">TRAFO</option>
<option value="MEDIDOR">MEDIDOR</option>
<option value="CC">CC</option>
</select>
</div>
<div class="reference-input">
<input id="numeroReferencia" placeholder="Número da referência" required="" type="text"/>
</div>
</div>
</div>
<!-- Relatório da Ocorrência -->

<!-- Alimentador -->
<div class="form-group half">
<label for="alimentador">
<i class="fas fa-plug"></i>
    Alimentador <span class="required">*</span>
</label>
<div class="input-wrapper">
<i class="fas fa-terminal input-icon"></i>
<input class="input-with-icon" id="alimentador" name="alimentador" pattern="[A-Za-z0-9\-]{1,10}" placeholder="ILH-01M2" required="" title="Digite letras e números no formato ILH-01M2" type="text"/>
</div>
</div>
<div class="form-group full">
<label for="relatorioOcorrencia">
<i class="fas fa-file-alt"></i>
                Relatório da Ocorrência <span class="required">*</span>
</label>
<textarea id="relatorioOcorrencia" placeholder="Descreva detalhadamente a ocorrência..." required=""></textarea>
</div>
<!-- Materiais Necessários -->
<div class="form-group full">
<label for="materiaisNecessarios">
<i class="fas fa-box"></i>
                Materiais Necessários <span class="required">*</span>
</label>
<textarea id="materiaisNecessarios" placeholder="Liste os materiais necessários para resolução da ocorrência..." required=""></textarea>
</div>
<!-- Botão Enviar -->
<div class="form-group full" style="margin-top: 1rem;">
<button class="btn btn-primary" id="btnEnviar" type="submit">
<i class="fas fa-paper-plane"></i>
                Enviar Ocorrência
              </button>
</div>
</div>
</form>
<!-- Mensagem de resultado -->
<div id="mensagemResultado" style="display: none;"></div>
</div>
</div>
</div>
<script>
// Configuração do Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCv7vfGMSobE1n0M1CECl46LdMy3pdrxh4",
  authDomain: "pedido-de-material---ilheus.firebaseapp.com",
  projectId: "pedido-de-material---ilheus",
  storageBucket: "pedido-de-material---ilheus.appspot.com",
  messagingSenderId: "155845988594",
  appId: "1:155845988594:web:322f34f9790f605a92006b"
};

// Inicializar Firebase
let db = null;
let firebaseInitialized = false;

function initializeFirebase() {
  try {
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    db = firebase.firestore();
    firebaseInitialized = true;
    console.log('Firebase inicializado com sucesso no index');
  } catch (error) {
    console.error('Erro ao inicializar Firebase no index:', error);
    firebaseInitialized = false;
  }
}

// Função para gerar ID único para acionamento
function gerarIdAcionamento() {
  return Date.now();
}

// Função para formatar data e hora inicial
function formatarDataHoraInicial() {
  const agora = new Date();
  
  // Formatar data (YYYY-MM-DD para input date)
  const data = agora.toISOString().split('T')[0];
  
  // Formatar hora (HH:MM para input time)
  const hora = agora.toTimeString().split(' ')[0].substring(0, 5);
  
  // Preencher campos apenas se estiverem vazios
  if (!document.getElementById('dataCriacao').value) {
    document.getElementById('dataCriacao').value = data;
  }
  if (!document.getElementById('horarioCriacao').value) {
    document.getElementById('horarioCriacao').value = hora;
  }
}

// Função para salvar acionamento no Firebase
async function salvarAcionamentoFirebase(dadosAcionamento) {
  if (!firebaseInitialized) {
    console.log('Firebase não inicializado, não é possível salvar');
    return false;
  }
  
  try {
    const id = gerarIdAcionamento();
    const agora = new Date();
    const acionamentoCompleto = {
      id: id,
      ...dadosAcionamento,
      status: 'PENDENTE',
      data_criacao: agora.toISOString(),
      data_criacao_formatada: agora.toLocaleDateString('pt-BR'),
      horario_criacao_formatado: agora.toLocaleTimeString('pt-BR'),
      equipe_alocada: null,
      historico: [
        {
          data: agora.toISOString(),
          usuario: 'SISTEMA',
          acao: 'Acionamento criado'
        }
      ]
    };
    
    await db.collection('acionamentos').doc(id.toString()).set(acionamentoCompleto);
    console.log(`Acionamento ${id} salvo no Firebase com sucesso`);
    return true;
  } catch (error) {
    console.error('Erro ao salvar acionamento no Firebase:', error);
    return false;
  }
}

// Função para formatar número da ocorrência
function formatarNumeroOcorrencia() {
  const input = document.getElementById('numeroOcorrencia');
  let valor = input.value.replace(/\D/g, ''); // Remove caracteres não numéricos
  
  if (valor.length >= 4) {
    const ano = valor.substring(0, 4);
    const mes = valor.substring(4, 6);
    const numero = valor.substring(6);
    
    if (mes.length === 2 && numero.length > 0) {
      input.value = `${ano}_${mes}_${numero}`;
    }
  }
}

// Função para validar formato do número da ocorrência
function validarNumeroOcorrencia(numero) {
  const regex = /^\d{4}_\d{2}_\d{1,6}$/;
  return regex.test(numero);
}

// Função para validar número da referência - CORRIGIDO: agora aceita letras e números
function validarNumeroReferencia(numero) {
  // Aceita letras, números e alguns caracteres especiais comuns em referências elétricas
  const regex = /^[A-Za-z0-9\-_\/\.]{1,15}$/;
  return regex.test(numero) && numero.length >= 1 && numero.length <= 15;
}

// Função para enviar acionamento
window.enviarAcionamento = async function(event) {
  event.preventDefault();
  
  const btnEnviar = document.getElementById('btnEnviar');
  const mensagemDiv = document.getElementById('mensagemResultado');
  
  // Desabilita o botão e mostra loading
  btnEnviar.disabled = true;
  btnEnviar.innerHTML = '<span class="loading"></span> Enviando...';
  
  try {
    // Coleta os dados do formulário
    const numeroOcorrencia = document.getElementById('numeroOcorrencia').value;
    const dataCriacao = document.getElementById('dataCriacao').value;
    const horarioCriacao = document.getElementById('horarioCriacao').value;
    const equipe = document.getElementById('equipe').value;
    const tipoEquipe = document.getElementById('tipoEquipe').value;
    const tipoDefeito = document.getElementById('tipoDefeito').value;
    const tipoReferencia = document.getElementById('tipoReferencia').value;
    const numeroReferencia = document.getElementById('numeroReferencia').value;
    const relatorioOcorrencia = document.getElementById('relatorioOcorrencia').value;
    const materiaisNecessarios = document.getElementById('materiaisNecessarios').value;
    
    const alimentador = document.getElementById('alimentador').value;

    // Validações
    if (!validarNumeroOcorrencia(numeroOcorrencia)) {
      throw new Error('Formato do número da ocorrência inválido. Use o formato: ANO_MÊS_NÚMERO (ex: 2025_08_000001)');
    }
    
    if (!validarNumeroReferencia(numeroReferencia)) {
      throw new Error('Número da referência deve conter entre 1 e 15 caracteres alfanuméricos');
    }
    
    // Dados para enviar para o Firebase
    const dadosAcionamento = {
      numero_ocorrencia: numeroOcorrencia,
      data_criacao_ocorrencia: dataCriacao,
      horario_criacao_ocorrencia: horarioCriacao,
      equipe,
      tipo_equipe: tipoEquipe,
      tipo_defeito: tipoDefeito,
      tipo_referencia: tipoReferencia,
      numero_referencia: numeroReferencia,
      alimentador,
      relatorio_ocorrencia: relatorioOcorrencia,
      materiais_necessarios: materiaisNecessarios
    };
    
    const sucesso = await salvarAcionamentoFirebase(dadosAcionamento);
    
    if (sucesso) {
      mensagemDiv.className = 'success-message fade-in';
      mensagemDiv.textContent = 'Ocorrência enviada com sucesso!';
      document.getElementById('acionamentoForm').reset();
      formatarDataHoraInicial(); // Preenche novamente com a data/hora atual
    } else {
      mensagemDiv.className = 'error-message fade-in';
      mensagemDiv.textContent = 'Erro ao enviar ocorrência. Tente novamente.';
    }
  } catch (error) {
    mensagemDiv.className = 'error-message fade-in';
    mensagemDiv.textContent = `Erro: ${error.message}`;
    console.error('Erro ao enviar acionamento:', error);
  } finally {
    mensagemDiv.style.display = 'block';
    btnEnviar.disabled = false;
    btnEnviar.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Ocorrência';
    setTimeout(() => {
      mensagemDiv.style.display = 'none';
    }, 5000);
  }
};

// Inicializar Firebase e preencher data/hora ao carregar a página
document.addEventListener('DOMContentLoaded', () => {
  initializeFirebase();
  formatarDataHoraInicial();
});

// Adicionar event listener para formatar o número da ocorrência ao digitar
document.getElementById('numeroOcorrencia').addEventListener('input', formatarNumeroOcorrencia);
</script>
</body>
</html>
